<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCard Manager</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Content-addressable card management system with local-first storage">
  <meta name="theme-color" content="#007acc">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MCard Manager">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Performance Optimization: Resource Hints -->
  <!-- Preconnect to CDN origins for faster loading -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  
  <!-- Preload critical CSS -->
  <link rel="preload" href="/css/mcard-manager.css" as="style">
  
  <!-- Preload critical JavaScript -->
  <link rel="preload" href="/js/mcard-manager-new.js" as="script" crossorigin>
  
  <!-- Define process.env for browser compatibility -->
  <script>
    // Redux Toolkit expects process.env.NODE_ENV
    window.process = {
      env: {
        NODE_ENV: 'production'
      }
    };
  </script>
  
  <!-- Auto-generate Import Map based on current URL -->
  <script>
    // Must run synchronously before any module imports
    (function() {
      const { protocol, hostname, port } = window.location;
      let baseUrl = `${protocol}//${hostname}`;
      if (port && port !== '80' && port !== '443') {
        baseUrl += `:${port}`;
      }
      
      const vendorPath = `${baseUrl}/vendor`;
      
      const importMap = {
        imports: {
          'redux': `${vendorPath}/redux/redux.esm.js`,
          'redux-thunk': `${vendorPath}/redux/redux-thunk-esm.js`,
          'immer': `${vendorPath}/redux/immer-esm.js`,
          'reselect': `${vendorPath}/redux/reselect-esm.js`,
          '@reduxjs/toolkit': `${vendorPath}/redux/toolkit.esm.js`,
          'mcard-js': `${baseUrl}/js/vendor/mcard-js.bundle.js`
        }
      };
      
      const script = document.createElement('script');
      script.type = 'importmap';
      script.textContent = JSON.stringify(importMap, null, 2);
      document.currentScript.parentNode.insertBefore(script, document.currentScript.nextSibling);
      
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        console.log('üåç Auto-detected BASE_URL:', baseUrl);
        console.log('üì¶ Import Map:', importMap);
      }
    })();
  </script>
  
  <!-- Lucide Icons - Self-Hosted -->
  <script src="/vendor/lucide/lucide.min.js"></script>
  <!-- MCard Manager CSS -->
  <link rel="stylesheet" href="/css/mcard-manager.css">
  <!-- Content Renderers CSS -->
  <link rel="stylesheet" href="/css/content-renderers.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <button class="header-btn" onclick="window.location.href='/'" style="margin-right: 12px;" title="Back to Landing Page">
          <i data-lucide="home" style="width: 16px; height: 16px;"></i>
          Home
        </button>
        <i data-lucide="package" style="width: 20px; height: 20px;"></i>
        <h1>MCard Manager</h1>
      </div>
      <div class="header-right">
        <button class="header-btn" onclick="document.getElementById('fileInput').click()">
          <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
          Upload
        </button>
        <button class="header-btn" onclick="createTextCard()">
          <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
          New Text
        </button>
        <button class="header-btn" onclick="toggleChat()">
          <i data-lucide="message-square" style="width: 16px; height: 16px;"></i>
          Chat
        </button>
      </div>
      <input type="file" id="fileInput" multiple style="display: none;">
    </div>

    <div class="main-content">
      <!-- Left Sidebar: File Types -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <h3>Card Types</h3>
            <button class="collapse-btn" id="collapseBtn" onclick="toggleSidebar()" title="Collapse sidebar">
              <i data-lucide="chevrons-left" style="width: 16px; height: 16px;"></i>
            </button>
          </div>
        </div>
        <div class="type-list" id="typeList">
          <!-- Card types will be populated here -->
        </div>
      </div>

      <!-- Middle Column: MCard List -->
      <div class="middle-column">
        <div class="mobile-back-btn" onclick="navigateBack()">
          <i data-lucide="chevron-left" style="width: 16px; height: 16px;"></i>
          Back to Types
        </div>
        <div class="column-header">
          <h3 id="columnTitle">All MCards</h3>
          <div style="position: relative; margin-top: 8px;">
            <i data-lucide="search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: #999;"></i>
            <input type="text" class="search-box" placeholder="Search files or @handle..." id="searchBox" style="width: 100%; padding-left: 40px; padding-right: 40px;">
            <button class="filter-toggle-btn" id="filterToggleBtn" onclick="toggleSearchFilters()" title="Search filters">
              <i data-lucide="filter" style="width: 16px; height: 16px;"></i>
            </button>
          </div>
          <!-- Search Filters Dropdown -->
          <div class="search-filters" id="searchFilters" style="display: none;">
            <div class="filter-section">
              <label class="filter-label">Filter by:</label>
              <div class="filter-options">
                <label class="filter-option">
                  <input type="checkbox" id="filterWithHandles" onchange="applySearchFilters()">
                  <span>With Handles Only</span>
                </label>
                <label class="filter-option">
                  <input type="checkbox" id="filterCapital" onchange="applySearchFilters()">
                  <span>Capital Letters Only</span>
                </label>
                <label class="filter-option">
                  <input type="checkbox" id="filterMarkdown" onchange="applySearchFilters()">
                  <span>Markdown Files</span>
                </label>
                <label class="filter-option">
                  <input type="checkbox" id="filterImages" onchange="applySearchFilters()">
                  <span>Images Only</span>
                </label>
                <label class="filter-option">
                  <input type="checkbox" id="filterVideos" onchange="applySearchFilters()">
                  <span>Videos Only</span>
                </label>
              </div>
            </div>
            <div class="filter-section">
              <label class="filter-label">Sort by:</label>
              <div class="filter-options">
                <label class="filter-option">
                  <input type="radio" name="sortBy" value="newest" checked onchange="applySearchFilters()">
                  <span>Newest First</span>
                </label>
                <label class="filter-option">
                  <input type="radio" name="sortBy" value="oldest" onchange="applySearchFilters()">
                  <span>Oldest First</span>
                </label>
                <label class="filter-option">
                  <input type="radio" name="sortBy" value="name" onchange="applySearchFilters()">
                  <span>Name (A-Z)</span>
                </label>
              </div>
            </div>
            <div class="filter-actions">
              <button class="filter-clear-btn" onclick="clearSearchFilters()">Clear All</button>
            </div>
          </div>
        </div>
        <div class="mcard-list" id="mcardList">
          <div class="empty-state">
            <div class="empty-state-icon">
              <i data-lucide="package" style="width: 64px; height: 64px; color: #ccc;"></i>
            </div>
            <p>No MCards yet. Upload some files to get started!</p>
          </div>
        </div>
      </div>

      <!-- Right Column: Viewer -->
      <div class="viewer-column">
        <div class="mobile-back-btn" onclick="navigateBack()">
          <i data-lucide="chevron-left" style="width: 16px; height: 16px;"></i>
          Back to Cards
        </div>
        <div class="viewer-header">
          <h3 id="viewerTitle">Select an MCard</h3>
          <div class="viewer-actions" id="viewerActions" style="display: none;">
            <button class="btn" style="font-size: 12px; padding: 8px 16px; display: flex; align-items: center; gap: 6px;" onclick="downloadCurrentCard()">
              <i data-lucide="download" style="width: 16px; height: 16px;"></i>
              Download
            </button>
            <button class="btn btn-secondary" style="font-size: 12px; padding: 8px 16px; display: flex; align-items: center; gap: 6px;" onclick="deleteCurrentCard()">
              <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
              Delete
            </button>
          </div>
        </div>
        <div class="viewer-content" id="viewerContent">
          <div class="upload-section" id="uploadSection">
            <div class="upload-icon">
              <i data-lucide="upload-cloud" style="width: 64px; height: 64px; color: #667eea;"></i>
            </div>
            <h2>Upload Files</h2>
            <p>Drag & drop files here or click Upload button</p>
            <div style="margin-top: 20px;">
              <p style="font-size: 14px; color: #666; margin-bottom: 12px;"><strong>Supported Types:</strong></p>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; text-align: left; max-width: 400px; margin: 0 auto;">
                <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="file-text" style="width: 16px; height: 16px;"></i> Text</div>
                <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="image" style="width: 16px; height: 16px;"></i> Images</div>
                <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="video" style="width: 16px; height: 16px;"></i> Videos</div>
                <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="music" style="width: 16px; height: 16px;"></i> Audio</div>
                <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="file" style="width: 16px; height: 16px;"></i> Documents</div>
                <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="archive" style="width: 16px; height: 16px;"></i> Archives</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Panel -->
      <div class="chat-panel hidden" id="chatPanel">
        <div class="chat-header">
          <h3>
            <i data-lucide="message-square" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></i>
            Chat Assistant
          </h3>
          <button class="chat-close-btn" onclick="toggleChat()">
            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
          </button>
        </div>
        <div class="chat-messages" id="chatMessages">
          <div class="chat-message assistant">
            <div class="chat-message-bubble">
              üëã Hello! I'm your MCard assistant. I can help you manage your files, answer questions about content-addressable storage, or just chat!
            </div>
            <div class="chat-message-time">Just now</div>
          </div>
        </div>
        <div class="chat-input-container">
          <textarea 
            class="chat-input" 
            id="chatInput" 
            placeholder="Type your message here..."
            rows="3"
          ></textarea>
          <button class="chat-send-btn" onclick="sendChatMessage()">
            <i data-lucide="send" style="width: 14px; height: 14px;"></i>
            Send Message
          </button>
        </div>
      </div>

      <!-- Edit Panel -->
      <div class="chat-panel hidden" id="editPanel">
        <div class="chat-header">
          <h3 id="editPanelTitle">
            <i data-lucide="edit-3" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></i>
            <span id="editPanelTitleText">New Text Card</span>
          </h3>
          <button class="chat-close-btn" onclick="closeEditPanel()">
            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
          </button>
        </div>
        <div class="chat-messages" style="padding: 16px;">
          <!-- Handle Name Input -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">
              <i data-lucide="tag" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></i>
              Handle Name
            </label>
            <input 
              type="text" 
              id="editHandleName" 
              class="search-box" 
              placeholder="e.g., my-document, readme, notes"
              style="width: 100%; padding: 10px 12px;"
            />
            <p style="font-size: 12px; color: #666; margin-top: 4px;">
              Optional: Give this card a friendly name for easy reference
            </p>
          </div>

          <!-- Content Editor -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">
              <i data-lucide="file-text" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></i>
              Content
            </label>
            <textarea 
              id="editContentArea" 
              class="chat-input" 
              placeholder="Enter your content here..."
              style="width: 100%; min-height: 300px; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 13px; line-height: 1.6; resize: vertical;"
            ></textarea>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 8px; justify-content: flex-end;">
            <button 
              class="btn btn-secondary" 
              onclick="closeEditPanel()"
              style="font-size: 14px; padding: 10px 20px;"
            >
              <i data-lucide="x" style="width: 14px; height: 14px;"></i>
              Cancel
            </button>
            <button 
              class="btn" 
              onclick="saveEditedCard()"
              style="font-size: 14px; padding: 10px 20px;"
            >
              <i data-lucide="save" style="width: 14px; height: 14px;"></i>
              <span id="editSaveButtonText">Save</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for viewing card details -->
  <div class="modal" id="cardModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>MCard Details</h2>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content will be populated here -->
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div class="toast" id="toast">
    <span id="toastIcon">‚úì</span>
    <span id="toastMessage">Success!</span>
  </div>

  <!-- Sidebar collapse functionality -->
  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('collapsed');
      
      // Re-initialize Lucide icons after DOM change
      if (window.lucide) {
        setTimeout(() => lucide.createIcons(), 100);
      }
    }

    // Auto-collapse sidebar on mobile devices
    function initializeSidebarState() {
      const sidebar = document.getElementById('sidebar');
      if (!sidebar) {
        console.warn('[Sidebar] Element not found');
        return;
      }
      
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        // Always collapse on mobile
        if (!sidebar.classList.contains('collapsed')) {
          sidebar.classList.add('collapsed');
        }
        console.log('[Sidebar] Auto-collapsed on mobile device (width: ' + window.innerWidth + 'px)');
      } else {
        // Always expand on desktop
        if (sidebar.classList.contains('collapsed')) {
          sidebar.classList.remove('collapsed');
        }
        console.log('[Sidebar] Auto-expanded on desktop (width: ' + window.innerWidth + 'px)');
      }
    }

    // Run immediately when script loads
    initializeSidebarState();
    
    // Also run on DOMContentLoaded to be safe
    window.addEventListener('DOMContentLoaded', initializeSidebarState);
    
    // Re-check on window resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        const sidebar = document.getElementById('sidebar');
        const isMobile = window.innerWidth <= 768;
        
        // Auto-collapse when resizing to mobile
        if (isMobile && !sidebar.classList.contains('collapsed')) {
          sidebar.classList.add('collapsed');
          console.log('[Sidebar] Auto-collapsed on resize to mobile');
        }
        // Auto-expand when resizing to desktop (optional)
        // Uncomment if you want sidebar to expand on desktop
        // else if (!isMobile && sidebar.classList.contains('collapsed')) {
        //   sidebar.classList.remove('collapsed');
        //   console.log('[Sidebar] Auto-expanded on resize to desktop');
        // }
      }, 250);
    });

    // Search filter functionality
    function toggleSearchFilters() {
      const filtersPanel = document.getElementById('searchFilters');
      const toggleBtn = document.getElementById('filterToggleBtn');
      
      console.log('[Filter] Toggle clicked, current display:', filtersPanel.style.display);
      
      if (filtersPanel.style.display === 'none' || filtersPanel.style.display === '') {
        filtersPanel.style.display = 'block';
        toggleBtn.classList.add('active');
        console.log('[Filter] Showing filters panel');
      } else {
        filtersPanel.style.display = 'none';
        toggleBtn.classList.remove('active');
        console.log('[Filter] Hiding filters panel');
      }
      
      // Re-initialize Lucide icons
      if (window.lucide) {
        setTimeout(() => lucide.createIcons(), 100);
      }
    }

    function applySearchFilters() {
      // Get filter values
      const withHandles = document.getElementById('filterWithHandles').checked;
      const capital = document.getElementById('filterCapital').checked;
      const markdown = document.getElementById('filterMarkdown').checked;
      const images = document.getElementById('filterImages').checked;
      const videos = document.getElementById('filterVideos').checked;
      const sortBy = document.querySelector('input[name="sortBy"]:checked').value;
      
      // Store filters in window object for MCardManager to access
      window.searchFilters = {
        withHandles,
        capital,
        markdown,
        images,
        videos,
        sortBy
      };
      
      // Trigger search update
      if (window.mcardManager) {
        window.mcardManager.applyFiltersAndSearch();
      }
    }

    function clearSearchFilters() {
      // Uncheck all checkboxes
      document.getElementById('filterWithHandles').checked = false;
      document.getElementById('filterCapital').checked = false;
      document.getElementById('filterMarkdown').checked = false;
      document.getElementById('filterImages').checked = false;
      document.getElementById('filterVideos').checked = false;
      
      // Reset sort to newest
      document.querySelector('input[name="sortBy"][value="newest"]').checked = true;
      
      // Clear filters and refresh
      window.searchFilters = null;
      if (window.mcardManager) {
        window.mcardManager.applyFiltersAndSearch();
      }
    }

    // Close filters when clicking outside
    document.addEventListener('click', function(event) {
      const filtersPanel = document.getElementById('searchFilters');
      const toggleBtn = document.getElementById('filterToggleBtn');
      const searchBox = document.getElementById('searchBox');
      
      if (filtersPanel && toggleBtn && searchBox) {
        if (!filtersPanel.contains(event.target) && 
            !toggleBtn.contains(event.target) && 
            !searchBox.contains(event.target)) {
          filtersPanel.style.display = 'none';
          toggleBtn.classList.remove('active');
        }
      }
    });
  </script>

  <!-- Performance Monitoring -->
  <script src="/js/performance-monitor.js"></script>

  <!-- MCard Manager JavaScript (Modular Version) -->
  <script type="module" src="/js/mcard-manager-new.js"></script>

  <!-- PWA Service Worker Registration -->
  <script>
    // Register service worker for PWA functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('[PWA] Service Worker registered successfully:', registration.scope);
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              console.log('[PWA] New service worker found, installing...');
              
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('[PWA] New version available! Refresh to update.');
                  
                  // Show update notification
                  if (confirm('A new version of MCard Manager is available. Reload to update?')) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch((error) => {
            console.error('[PWA] Service Worker registration failed:', error);
          });

        // Handle service worker updates
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!refreshing) {
            refreshing = true;
            window.location.reload();
          }
        });
      });
    }

    // PWA Install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('[PWA] Install prompt available');
      e.preventDefault();
      deferredPrompt = e;
      
      // Show custom install button (optional)
      showInstallPromotion();
    });

    function showInstallPromotion() {
      // Create install banner if it doesn't exist
      const existingBanner = document.getElementById('pwa-install-banner');
      if (existingBanner) return;

      // Create banner
      const banner = document.createElement('div');
      banner.id = 'pwa-install-banner';
      banner.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #007acc 0%, #005a9e 100%);
        color: white;
        padding: 16px 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: space-between;
        animation: slideDown 0.3s ease-out;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      `;

      banner.innerHTML = `
        <style>
          @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
          }
          @media (max-width: 768px) {
            #pwa-install-banner {
              flex-direction: column;
              gap: 12px;
              padding: 12px 16px !important;
            }
            #pwa-install-banner .banner-content {
              flex-direction: column;
              align-items: flex-start !important;
              gap: 8px !important;
            }
            #pwa-install-banner .banner-actions {
              width: 100%;
              justify-content: stretch !important;
            }
            #pwa-install-banner button {
              flex: 1;
            }
          }
        </style>
        <div class="banner-content" style="display: flex; align-items: center; gap: 16px; flex: 1;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <i data-lucide="download-cloud" style="width: 32px; height: 32px; min-width: 32px;"></i>
            <div>
              <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Install MCard Manager</div>
              <div style="font-size: 13px; opacity: 0.9;">Get faster access and work offline</div>
            </div>
          </div>
        </div>
        <div class="banner-actions" style="display: flex; gap: 12px; align-items: center;">
          <button id="install-btn" style="
            background: white;
            color: #007acc;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
          ">
            Install
          </button>
          <button id="dismiss-btn" style="
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
          ">
            Not Now
          </button>
        </div>
      `;

      // Add hover effects
      const style = document.createElement('style');
      style.textContent = `
        #install-btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #dismiss-btn:hover {
          background: rgba(255,255,255,0.1);
        }
      `;
      document.head.appendChild(style);

      document.body.appendChild(banner);

      // Initialize Lucide icons
      if (window.lucide) {
        lucide.createIcons();
      }

      // Install button handler
      document.getElementById('install-btn').addEventListener('click', async () => {
        if (!deferredPrompt) return;
        
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log('[PWA] User choice:', outcome);
        
        if (outcome === 'accepted') {
          console.log('[PWA] App installed successfully!');
        }
        
        deferredPrompt = null;
        banner.style.animation = 'slideDown 0.3s ease-out reverse';
        setTimeout(() => banner.remove(), 300);
      });

      // Dismiss button handler
      document.getElementById('dismiss-btn').addEventListener('click', () => {
        banner.style.animation = 'slideDown 0.3s ease-out reverse';
        setTimeout(() => banner.remove(), 300);
        
        // Remember dismissal for 7 days
        localStorage.setItem('pwa-install-dismissed', Date.now());
      });

      // Auto-show again after 7 days if dismissed
      const dismissed = localStorage.getItem('pwa-install-dismissed');
      if (dismissed && Date.now() - parseInt(dismissed) < 7 * 24 * 60 * 60 * 1000) {
        banner.remove();
      }
    }

    // Detect if app is running as PWA
    window.addEventListener('load', () => {
      if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
        console.log('[PWA] Running as installed app');
        document.body.classList.add('pwa-mode');
      }
    });

    // Handle share target (if app receives shared content)
    if (window.location.search.includes('share-target')) {
      console.log('[PWA] Received shared content');
      // Handle shared content here
    }
  </script>
</body>
</html>

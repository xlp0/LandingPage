<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Calendar</title>
    <link rel="stylesheet" href="/css/google-calendar.css">
</head>
<body>
    <div id="auth-section" class="auth-section" style="display: none;">
        <div class="calendar-logo">
            <div class="calendar-logo-icon">üìÖ</div>
            <div class="calendar-logo-text">Calendar</div>
        </div>
        <h1 class="auth-title">Welcome to Google Calendar</h1>
        <p class="auth-description">Sign in with your Google account to view and manage your calendar events</p>
        <button id="authorize-button" class="auth-button">Sign in with Google</button>
    </div>

    <div id="loading" class="loading" style="display: flex;">
        Loading Calendar...
    </div>

    <div id="calendar-app" class="calendar-container" style="display: none;">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="calendar-logo">
                    <div class="calendar-logo-icon">üìÖ</div>
                    <div class="calendar-logo-text">Calendar</div>
                </div>
            </div>

            <button class="create-button">
                <span class="create-button-icon">+</span>
                <span class="create-button-text">Create</span>
            </button>

            <!-- Mini Calendar -->
            <div class="mini-calendar">
                <div class="mini-calendar-header">
                    <div class="mini-calendar-month" id="mini-month">December 2025</div>
                    <div class="mini-calendar-nav">
                        <button id="mini-prev">‚Äπ</button>
                        <button id="mini-next">‚Ä∫</button>
                    </div>
                </div>
                <div class="mini-calendar-grid" id="mini-calendar-grid">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Search -->
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" placeholder="Search for people">
            </div>

            <!-- My Calendars -->
            <div class="calendar-section">
                <div class="calendar-section-header" onclick="toggleSection('my-calendars')">
                    <span class="calendar-section-title">My calendars</span>
                    <span class="calendar-section-toggle" id="my-calendars-toggle">‚ñº</span>
                </div>
                <div class="calendar-list" id="my-calendars-list">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Other Calendars -->
            <div class="calendar-section">
                <div class="calendar-section-header" onclick="toggleSection('other-calendars')">
                    <span class="calendar-section-title">Other calendars</span>
                    <span class="calendar-section-toggle" id="other-calendars-toggle">‚ñº</span>
                </div>
                <div class="calendar-list" id="other-calendars-list">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>

        <!-- Main Calendar Area -->
        <div class="main-calendar">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="menu-button">‚ò∞</button>
                    <button class="today-button" id="today-button">Today</button>
                    <div class="calendar-nav">
                        <button class="nav-button" id="prev-month">‚Äπ</button>
                        <button class="nav-button" id="next-month">‚Ä∫</button>
                    </div>
                    <div class="current-date" id="current-date">December 2025</div>
                </div>
                <div class="top-bar-right">
                    <div class="view-selector">
                        <span>Month</span>
                        <span>‚ñº</span>
                    </div>
                    <button class="icon-button">‚öôÔ∏è</button>
                    <button class="icon-button">‚ùì</button>
                    <button class="icon-button" id="signout-button">üë§</button>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="calendar-grid-container">
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div class="event-modal" id="event-modal">
        <div class="event-modal-content">
            <div class="event-modal-header">
                <h2 class="event-modal-title" id="modal-title">Event Title</h2>
                <button class="event-modal-close" onclick="closeEventModal()">√ó</button>
            </div>
            <div class="event-modal-body" id="modal-body">
                <!-- Generated by JS -->
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        const API_KEY = 'AIzaSyBFnvQpbGWsaqlRddIeM0ZAhzwmbhE4oFk';
        const CLIENT_ID = '453579831938-addktpr31j59mgitmuiemjtkb5pjs5am.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let currentDate = new Date();
        let calendars = [];
        let events = [];
        let calendarColors = {};

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableAuth();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableAuth();
        }

        function maybeEnableAuth() {
            if (gapiInited && gisInited) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('auth-section').style.display = 'flex';
            }
        }

        document.getElementById('authorize-button').addEventListener('click', handleAuthClick);

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('calendar-app').style.display = 'flex';
                await loadCalendars();
                await loadEvents();
                renderCalendar();
                renderMiniCalendar();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        document.getElementById('signout-button').addEventListener('click', handleSignoutClick);

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('calendar-app').style.display = 'none';
                document.getElementById('auth-section').style.display = 'flex';
            }
        }

        async function loadCalendars() {
            try {
                const response = await gapi.client.calendar.calendarList.list();
                calendars = response.result.items || [];
                
                calendarColors = {};
                calendars.forEach(cal => {
                    calendarColors[cal.id] = cal.backgroundColor || '#1a73e8';
                });

                renderCalendarLists();
            } catch (err) {
                console.error('Error loading calendars:', err);
            }
        }

        function renderCalendarLists() {
            const myCalendarsList = document.getElementById('my-calendars-list');
            const otherCalendarsList = document.getElementById('other-calendars-list');
            
            myCalendarsList.innerHTML = '';
            otherCalendarsList.innerHTML = '';

            calendars.forEach(calendar => {
                const item = document.createElement('div');
                item.className = 'calendar-item';
                item.innerHTML = `
                    <div class="calendar-checkbox checked" data-calendar-id="${calendar.id}"></div>
                    <span class="calendar-name">${calendar.summary}</span>
                    <div class="calendar-color" style="background: ${calendar.backgroundColor || '#1a73e8'}"></div>
                `;
                
                item.querySelector('.calendar-checkbox').addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.target.classList.toggle('checked');
                    loadEvents();
                });

                if (calendar.primary || calendar.accessRole === 'owner') {
                    myCalendarsList.appendChild(item);
                } else {
                    otherCalendarsList.appendChild(item);
                }
            });
        }

        async function loadEvents() {
            const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            
            events = [];
            
            const checkedCalendars = Array.from(document.querySelectorAll('.calendar-checkbox.checked'))
                .map(cb => cb.dataset.calendarId);

            for (const calendarId of checkedCalendars) {
                try {
                    const response = await gapi.client.calendar.events.list({
                        calendarId: calendarId,
                        timeMin: startOfMonth.toISOString(),
                        timeMax: endOfMonth.toISOString(),
                        showDeleted: false,
                        singleEvents: true,
                        orderBy: 'startTime',
                    });

                    const calendarEvents = (response.result.items || []).map(event => ({
                        ...event,
                        calendarId: calendarId,
                        color: calendarColors[calendarId] || '#1a73e8'
                    }));

                    events.push(...calendarEvents);
                } catch (err) {
                    console.error(`Error loading events for calendar ${calendarId}:`, err);
                }
            }

            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('current-date').textContent = 
                currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const dayHeaders = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            for (let i = firstDay - 1; i >= 0; i--) {
                const cell = createCalendarCell(daysInPrevMonth - i, true, false);
                grid.appendChild(cell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = isCurrentMonth && day === today.getDate();
                const cell = createCalendarCell(day, false, isToday);
                grid.appendChild(cell);
            }

            const remainingCells = 42 - (firstDay + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                const cell = createCalendarCell(day, true, false);
                grid.appendChild(cell);
            }
        }

        function createCalendarCell(day, isOtherMonth, isToday) {
            const cell = document.createElement('div');
            cell.className = 'calendar-cell';
            if (isOtherMonth) cell.classList.add('other-month');
            if (isToday) cell.classList.add('today');

            const dateDiv = document.createElement('div');
            dateDiv.className = 'calendar-date';
            dateDiv.textContent = day;
            cell.appendChild(dateDiv);

            if (!isOtherMonth) {
                const eventsDiv = document.createElement('div');
                eventsDiv.className = 'calendar-events';
                
                const cellDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const dayEvents = events.filter(event => {
                    const eventDate = new Date(event.start.dateTime || event.start.date);
                    return eventDate.getDate() === day && 
                           eventDate.getMonth() === currentDate.getMonth() &&
                           eventDate.getFullYear() === currentDate.getFullYear();
                });

                dayEvents.slice(0, 3).forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'calendar-event';
                    eventDiv.style.background = event.color;
                    eventDiv.textContent = event.summary;
                    eventDiv.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showEventModal(event);
                    });
                    eventsDiv.appendChild(eventDiv);
                });

                if (dayEvents.length > 3) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'calendar-event';
                    moreDiv.style.background = '#70757a';
                    moreDiv.textContent = `+${dayEvents.length - 3} more`;
                    eventsDiv.appendChild(moreDiv);
                }

                cell.appendChild(eventsDiv);
            }

            return cell;
        }

        function renderMiniCalendar() {
            const grid = document.getElementById('mini-calendar-grid');
            grid.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('mini-month').textContent = 
                currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'mini-calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            for (let i = firstDay - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'mini-calendar-day other-month';
                day.textContent = daysInPrevMonth - i;
                grid.appendChild(day);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'mini-calendar-day';
                if (isCurrentMonth && day === today.getDate()) {
                    dayDiv.classList.add('today');
                }
                dayDiv.textContent = day;
                grid.appendChild(dayDiv);
            }

            const remainingCells = 42 - (firstDay + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'mini-calendar-day other-month';
                dayDiv.textContent = day;
                grid.appendChild(dayDiv);
            }
        }

        function showEventModal(event) {
            const modal = document.getElementById('event-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = event.summary || 'Untitled Event';

            const startDate = new Date(event.start.dateTime || event.start.date);
            const endDate = new Date(event.end.dateTime || event.end.date);
            
            const formatDate = (date) => {
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            };

            const formatTime = (date) => {
                return date.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
            };

            body.innerHTML = `
                <div class="event-detail-row">
                    <div class="event-detail-icon">üïê</div>
                    <div class="event-detail-content">
                        <div class="event-detail-label">Time</div>
                        <div class="event-detail-value">
                            ${formatDate(startDate)}<br>
                            ${event.start.dateTime ? formatTime(startDate) + ' - ' + formatTime(endDate) : 'All day'}
                        </div>
                    </div>
                </div>
                ${event.location ? `
                <div class="event-detail-row">
                    <div class="event-detail-icon">üìç</div>
                    <div class="event-detail-content">
                        <div class="event-detail-label">Location</div>
                        <div class="event-detail-value">${event.location}</div>
                    </div>
                </div>
                ` : ''}
                ${event.description ? `
                <div class="event-detail-row">
                    <div class="event-detail-icon">üìù</div>
                    <div class="event-detail-content">
                        <div class="event-detail-label">Description</div>
                        <div class="event-detail-value">${event.description}</div>
                    </div>
                </div>
                ` : ''}
                ${event.attendees ? `
                <div class="event-detail-row">
                    <div class="event-detail-icon">üë•</div>
                    <div class="event-detail-content">
                        <div class="event-detail-label">Guests</div>
                        <div class="event-detail-value">
                            ${event.attendees.map(a => a.email).join('<br>')}
                        </div>
                    </div>
                </div>
                ` : ''}
            `;

            modal.classList.add('active');
        }

        function closeEventModal() {
            document.getElementById('event-modal').classList.remove('active');
        }

        function toggleSection(sectionId) {
            const toggle = document.getElementById(`${sectionId}-toggle`);
            const list = document.getElementById(`${sectionId}-list`);
            
            if (list.style.display === 'none') {
                list.style.display = 'block';
                toggle.classList.remove('collapsed');
            } else {
                list.style.display = 'none';
                toggle.classList.add('collapsed');
            }
        }

        document.getElementById('prev-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            loadEvents();
            renderMiniCalendar();
        });

        document.getElementById('next-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            loadEvents();
            renderMiniCalendar();
        });

        document.getElementById('today-button').addEventListener('click', () => {
            currentDate = new Date();
            loadEvents();
            renderMiniCalendar();
        });

        document.getElementById('mini-prev').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            loadEvents();
            renderMiniCalendar();
        });

        document.getElementById('mini-next').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            loadEvents();
            renderMiniCalendar();
        });

        document.getElementById('event-modal').addEventListener('click', (e) => {
            if (e.target.id === 'event-modal') {
                closeEventModal();
            }
        });

        gapiLoaded();
        gisLoaded();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    
    <!-- Aggressive cache control to prevent stale code -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>WebRTC Dashboard - P2P Chat Rooms</title>
    <link rel="stylesheet" href="styles.css">
    <!-- iOS Safari specific -->
    <meta name="format-detection" content="telephone=no">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üåê</text></svg>">
    
    <!-- Check for existing authentication -->
    <script>
        // Check if user is already authenticated from main site
        function checkExistingAuth() {
            try {
                const userStr = localStorage.getItem('user');
                const token = localStorage.getItem('auth_token');
                
                if (userStr && token) {
                    const user = JSON.parse(userStr);
                    console.log('[WebRTC Dashboard] Found authenticated user:', user);
                    return user;
                }
            } catch (error) {
                console.error('[WebRTC Dashboard] Error checking auth:', error);
            }
            return null;
        }
        
        // Pre-populate user name if authenticated
        window.addEventListener('DOMContentLoaded', () => {
            const user = checkExistingAuth();
            if (user) {
                const userNameInput = document.getElementById('user-name');
                const authStatus = document.getElementById('auth-status');
                const authUserDisplay = document.getElementById('auth-user-display');
                
                let displayName = '';
                
                if (user.name) {
                    displayName = user.name;
                    if (userNameInput) userNameInput.value = user.name;
                    console.log('[WebRTC Dashboard] Pre-populated user name:', user.name);
                } else if (user.email) {
                    displayName = user.email.split('@')[0];
                    if (userNameInput) userNameInput.value = displayName;
                    console.log('[WebRTC Dashboard] Pre-populated from email:', user.email);
                }
                
                // Show auth status badge
                if (authStatus && authUserDisplay && displayName) {
                    authUserDisplay.textContent = displayName;
                    authStatus.style.display = 'block';
                }
            }
        });
    </script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Login View (Shown First) -->
        <div id="login-view" class="login-view">
            <div class="login-container">
                <div class="login-header">
                    <h1>üåê WebRTC Dashboard</h1>
                    <p>Serverless P2P Chat Rooms</p>
                    <div id="auth-status" style="margin-top: 10px; padding: 8px 12px; background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.5); border-radius: 6px; font-size: 14px; display: none;">
                        ‚úì Authenticated as <span id="auth-user-display"></span>
                    </div>
                </div>
                <div class="login-form">
                    <input type="text" id="user-name" placeholder="Enter your name..." value="" maxlength="50">
                    <button id="login-btn" class="primary-btn">Login</button>
                    <a href="/index.html" style="display: block; margin-top: 12px; color: rgba(255, 255, 255, 0.7); text-decoration: none; font-size: 14px;">‚Üê Back to Home</a>
                </div>
            </div>
        </div>

        <!-- Main Dashboard (Hidden Initially) -->
        <div id="main-dashboard" class="main-dashboard hidden">
            <!-- Header -->
            <header class="dashboard-header">
                <h1>üåê WebRTC Dashboard</h1>
                <div class="header-actions">
                    <div class="user-badge-editable">
                        <span>üë§</span>
                        <input type="text" id="current-user-name" class="user-name-edit" placeholder="Your name..." maxlength="50">
                        <button id="save-user-name-btn" class="save-name-btn" title="Save name">‚úîÔ∏è</button>
                    </div>
                    <button id="create-room-btn" class="primary-btn">‚ûï Create Room</button>
                </div>
            </header>

            <!-- Available Rooms Section -->
            <main class="dashboard-main">
                <section class="available-rooms">
                    <div class="section-header">
                        <h2>Available Rooms</h2>
                        <div class="room-controls">
                            <button id="refresh-rooms-btn">üîÑ Refresh</button>
                            <input type="text" id="search-rooms" placeholder="Search rooms...">
                        </div>
                    </div>
                    <div id="rooms-list" class="rooms-grid">
                        <div class="no-rooms-message">
                            <p>No rooms available. Create one to get started!</p>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Chat Room View (Hidden by default) -->
        <div id="chat-room-view" class="chat-room-view hidden">
            <div class="chat-header">
                <div class="room-info">
                    <h2 id="current-room-name">Room Name</h2>
                    <span id="current-room-status">Connected</span>
                </div>
                <div class="room-actions">
                    <button id="share-room-btn">üîó Share Room</button>
                    <button id="transfer-host-btn" class="host-only hidden">üëë Transfer Host</button>
                    <button id="leave-room-btn">üö™ Leave Room</button>
                </div>
            </div>

            <div class="chat-content">
                <!-- Participants List -->
                <div class="participants-panel">
                    <h3>Participants (<span id="participant-count">0</span>)</h3>
                    <div id="participants-list" class="participants-list"></div>
                    
                    <!-- Host Controls -->
                    <div id="host-controls" class="host-controls host-only hidden">
                        <h4>Host Controls</h4>
                        <div id="pending-requests" class="pending-requests">
                            <h5>Join Requests</h5>
                            <div id="requests-list" class="requests-list">
                                <p class="no-requests">No pending requests</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-panel">
                    <div id="chat-messages" class="chat-messages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-input" placeholder="Type your message..." maxlength="500">
                        <button id="send-message-btn">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <!-- Room Link Modal -->
        <div id="room-link-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üîó Share Room</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Share this link with others to invite them to the room:</p>
                    <div class="link-container">
                        <input type="text" id="shareable-link" readonly>
                        <button id="copy-link-btn">üìã Copy</button>
                    </div>
                    <div class="link-options">
                        <label>
                            <input type="checkbox" id="instant-join-link">
                            Create instant join link (bypasses approval)
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Join Request Modal -->
        <div id="join-request-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Join Room Request</h3>
                </div>
                <div class="modal-body">
                    <p>Enter your display name to request access to this room:</p>
                    <input type="text" id="join-name-input" placeholder="Your name..." maxlength="50">
                    <textarea id="join-message-input" placeholder="Optional message to host..." maxlength="200"></textarea>
                    <div class="modal-actions">
                        <button id="send-join-request-btn" class="primary-btn">Send Request</button>
                        <button id="cancel-join-btn">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Host Transfer Modal -->
        <div id="host-transfer-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üëë Transfer Host</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Select a participant to transfer host privileges to:</p>
                    <div id="transfer-participants-list" class="transfer-list"></div>
                    <textarea id="transfer-reason" placeholder="Optional reason for transfer..." maxlength="200"></textarea>
                    <div class="modal-actions">
                        <button id="confirm-transfer-btn" class="primary-btn" disabled>Transfer Host</button>
                        <button class="close-modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Room Modal -->
        <div id="create-room-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>‚ûï Create New Room</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="create-room-form">
                        <input type="text" id="room-name" placeholder="Room name..." maxlength="50">
                        <textarea id="room-description" placeholder="Room description (optional)..." maxlength="200"></textarea>
                        <div class="room-options">
                            <label>
                                <input type="checkbox" id="require-approval" checked>
                                Require host approval for new members
                            </label>
                            <label>
                                Max participants: 
                                <select id="max-participants">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                </select>
                            </label>
                        </div>
                        <div class="modal-actions">
                            <button id="confirm-create-room-btn" class="primary-btn">üè† Create & Join Room</button>
                            <button class="close-modal">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="connection-status">
                <span id="connection-indicator" class="status-indicator offline"></span>
                <span id="connection-text">Initializing...</span>
            </div>
            <div class="room-status">
                <span id="room-indicator" class="status-indicator"></span>
                <span id="room-text">No room</span>
            </div>
        </div>
    </div>

    <!-- Mobile participants toggle button -->
    <button class="mobile-participants-toggle" id="mobile-participants-toggle" style="display: none;">
        üë•
    </button>

    <!-- Redux Toolkit - Load synchronously before modules -->
    <script src="https://unpkg.com/@reduxjs/toolkit@2.0.1/dist/redux-toolkit.umd.min.js"></script>
    
    <!-- Scripts -->
    <script type="module">
        // Dynamic cache busting using timestamp
        const cacheBuster = Date.now();
        
        // Initialize Redux Store
        let store = null;
        
        async function initReduxStore() {
            try {
                console.log('[Dashboard] Initializing Redux store...');
                
                // Wait for Redux Toolkit to be available
                if (!window.RTK) {
                    console.error('[Dashboard] ‚ùå Redux Toolkit not loaded! Waiting...');
                    await new Promise(resolve => {
                        const checkRTK = setInterval(() => {
                            if (window.RTK) {
                                clearInterval(checkRTK);
                                console.log('[Dashboard] ‚úÖ Redux Toolkit loaded');
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                // Import Redux slices (from shared store directory)
                const authModule = await import(`../../store/authSlice.js?v=${cacheBuster}`);
                const connectionModule = await import(`../../store/connectionSlice.js?v=${cacheBuster}`);
                
                // Create store
                const { configureStore } = window.RTK;
                store = configureStore({
                    reducer: {
                        auth: authModule.default,
                        connection: connectionModule.default
                    }
                });
                
                // Load existing auth state from localStorage
                const userStr = localStorage.getItem('user');
                const token = localStorage.getItem('auth_token');
                if (userStr && token) {
                    const user = JSON.parse(userStr);
                    store.dispatch(authModule.setUser(user));
                    store.dispatch(authModule.setToken(token));
                    console.log('[Dashboard] Redux auth state loaded:', user);
                }
                
                // Make store globally available
                window.reduxStore = store;
                
                console.log('[Dashboard] ‚úÖ Redux store initialized');
                return store;
            } catch (error) {
                console.error('[Dashboard] ‚ùå Failed to initialize Redux store:', error);
                throw error;
            }
        }
        
        // Initialize dashboard
        async function initDashboard() {
            try {
                // Initialize Redux first
                await initReduxStore();
                
                // Load configuration
                const { loadConfig } = await import(`./config.js?v=${cacheBuster}`);
                await loadConfig();
                
                // Load dashboard manager
                const { DashboardManager } = await import(`./dashboard-manager-v2.js?v=${cacheBuster}`);
                window.dashboard = new DashboardManager(store);
                await window.dashboard.init();
                
                // Setup mobile participants toggle
                setupMobileParticipantsToggle();
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                document.getElementById('connection-text').textContent = 'Failed to initialize';
            }
        }
        
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDashboard);
        } else {
            // DOM already loaded
            initDashboard();
        }

        // Handle URL parameters for direct room joining
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const token = urlParams.get('token');
        const instant = urlParams.get('instant') === 'true';

        if (roomId && token) {
            // Store join parameters for after initialization
            window.pendingRoomJoin = { roomId, token, instant };
        }
        
        // Mobile participants panel toggle
        function setupMobileParticipantsToggle() {
            const toggle = document.getElementById('mobile-participants-toggle');
            const panel = document.querySelector('.participants-panel');
            
            if (!toggle || !panel) return;
            
            // Show toggle button on mobile
            if (window.innerWidth <= 768) {
                toggle.style.display = 'block';
            }
            
            toggle.addEventListener('click', () => {
                panel.classList.toggle('mobile-open');
                toggle.textContent = panel.classList.contains('mobile-open') ? '‚úï' : 'üë•';
            });
            
            // Close panel when clicking outside
            document.addEventListener('click', (e) => {
                if (panel.classList.contains('mobile-open') && 
                    !panel.contains(e.target) && 
                    !toggle.contains(e.target)) {
                    panel.classList.remove('mobile-open');
                    toggle.textContent = 'üë•';
                }
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth <= 768) {
                    toggle.style.display = 'block';
                } else {
                    toggle.style.display = 'none';
                    panel.classList.remove('mobile-open');
                }
            });
        }
    </script>
</body>
</html>

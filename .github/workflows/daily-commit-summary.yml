name: Daily Commit Summary Reports by User

on:
  schedule:
    # Runs at 06:00 WITA (22:00 UTC previous day)
    # WITA = UTC+8, so 06:00 WITA = 22:00 UTC
    - cron: '0 22 * * *'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  generate-daily-reports:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for commit analysis
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client minio

      - name: Install LaTeX (for PDF generation)
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-fonts-recommended texlive-fonts-extra texlive-latex-extra

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama --version

      - name: Cache Ollama models
        uses: actions/cache@v4
        with:
          path: ~/.ollama
          key: ${{ runner.os }}-ollama-llama3.2
          restore-keys: |
            ${{ runner.os }}-ollama-

      - name: Start Ollama daemon
        run: |
          nohup ollama serve > /tmp/ollama-serve.log 2>&1 &
          for i in $(seq 1 30); do
            if curl -fsS http://127.0.0.1:11434/api/tags > /dev/null; then
              echo "Ollama is up"
              exit 0
            fi
            sleep 1
          done
          echo "Ollama failed to start"
          cat /tmp/ollama-serve.log || true
          exit 1

      - name: Pull Ollama llama3.2 model
        run: |
          echo "Pulling llama3.2 model..."
          ollama pull llama3.2
          echo "Model pulled successfully"
      
      - name: Get yesterday's commits
        id: get-commits
        run: |
          # Calculate yesterday's date in WITA timezone
          YESTERDAY=$(TZ='Asia/Makassar' date -d 'yesterday' '+%Y-%m-%d')
          TODAY=$(TZ='Asia/Makassar' date '+%Y-%m-%d')
          
          echo "Collecting commits from: $YESTERDAY"
          echo "yesterday=$YESTERDAY" >> $GITHUB_OUTPUT
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          
          # Get commits from yesterday in WITA timezone
          git log --since="$YESTERDAY 00:00:00" --until="$YESTERDAY 23:59:59" \
            --pretty=format:"%H|%an|%ae|%ad|%s|%b" --date=iso > commits.txt
          
          COMMIT_COUNT=$(wc -l < commits.txt)
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          
          if [ $COMMIT_COUNT -eq 0 ]; then
            echo "No commits found for yesterday ($YESTERDAY)"
            echo "has_commits=false" >> $GITHUB_OUTPUT
          else
            echo "Found $COMMIT_COUNT commits for yesterday"
            echo "has_commits=true" >> $GITHUB_OUTPUT
            cat commits.txt
          fi
      
      - name: Process commits by user with AI
        id: process-commits
        if: steps.get-commits.outputs.has_commits == 'true'
        run: |
          chmod +x .github/scripts/process_commits.py
          python3 .github/scripts/process_commits.py commits.txt
      
      - name: Convert reports to PDF
        if: steps.get-commits.outputs.has_commits == 'true'
        run: |
          chmod +x .github/scripts/convert_to_pdf.py
          
          # Convert each user's markdown to PDF
          if [ -f "daily-reports/henry_${{ steps.get-commits.outputs.yesterday }}.md" ]; then
            python3 .github/scripts/convert_to_pdf.py "daily-reports/henry_${{ steps.get-commits.outputs.yesterday }}.md"
          fi
          
          if [ -f "daily-reports/alessandro_${{ steps.get-commits.outputs.yesterday }}.md" ]; then
            python3 .github/scripts/convert_to_pdf.py "daily-reports/alessandro_${{ steps.get-commits.outputs.yesterday }}.md"
          fi
      
      - name: Upload reports to MinIO
        if: steps.get-commits.outputs.has_commits == 'true'
        env:
          MINIO_ENDPOINT: minio.pkc.pub
          MINIO_ACCESS_KEY: ${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY: ${{ secrets.MINIO_SECRET_KEY }}
        run: |
          chmod +x .github/scripts/upload_to_minio.py
          python3 .github/scripts/upload_to_minio.py daily-reports/processing_results.json
      
      - name: Create Google Calendar Events
        if: steps.get-commits.outputs.has_commits == 'true'
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
        run: |
          chmod +x .github/scripts/create_calendar_events.py
          python3 .github/scripts/create_calendar_events.py daily-reports/upload_results.json daily-reports/processing_results.json
      
      - name: No commits notification
        if: steps.get-commits.outputs.has_commits == 'false'
        run: |
          echo "ℹ️ No commits found for yesterday. Skipping report generation."
          echo "This is normal if no development work was done yesterday."
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-reports-${{ steps.get-commits.outputs.yesterday }}
          path: |
            commits.txt
            daily-reports/
          retention-days: 30

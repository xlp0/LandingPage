name: CLM Test - All Components

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'components/**/*.html'
      - 'tests/test-clm-*.spec.js'
      - '.github/workflows/clm-test-all-components.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'components/**/*.html'
      - 'tests/test-clm-*.spec.js'
      - '.github/workflows/clm-test-all-components.yml'
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      welcome: ${{ steps.filter.outputs.welcome }}
      hero-content: ${{ steps.filter.outputs.hero-content }}
      p2p-status: ${{ steps.filter.outputs.p2p-status }}
      crash-test: ${{ steps.filter.outputs.crash-test }}
      wikipedia-viewer: ${{ steps.filter.outputs.wikipedia-viewer }}
      user-list: ${{ steps.filter.outputs.user-list }}
      user-detail: ${{ steps.filter.outputs.user-detail }}
      redux-state-viewer: ${{ steps.filter.outputs.redux-state-viewer }}
      wikipedia-search: ${{ steps.filter.outputs.wikipedia-search }}
      external-site-demo: ${{ steps.filter.outputs.external-site-demo }}
      google-maps: ${{ steps.filter.outputs.google-maps }}
      pkc-viewer: ${{ steps.filter.outputs.pkc-viewer }}
      grafana-faro: ${{ steps.filter.outputs.grafana-faro }}
      youtube-viewer: ${{ steps.filter.outputs.youtube-viewer }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            welcome:
              - 'components/welcome.html'
              - 'tests/test-clm-welcome.spec.js'
            hero-content:
              - 'components/hero.html'
              - 'tests/test-clm-hero-content.spec.js'
            p2p-status:
              - 'components/p2p-status.html'
              - 'tests/test-clm-p2p-status.spec.js'
            crash-test:
              - 'components/crash-test.html'
              - 'tests/test-clm-crash-test.spec.js'
            wikipedia-viewer:
              - 'components/wikipedia-viewer.html'
              - 'tests/test-clm-wikipedia-viewer.spec.js'
            user-list:
              - 'components/user-list.html'
              - 'tests/test-clm-user-list.spec.js'
            user-detail:
              - 'components/user-detail.html'
              - 'tests/test-clm-user-detail.spec.js'
            redux-state-viewer:
              - 'components/redux-state-viewer.html'
              - 'tests/test-clm-redux-state-viewer.spec.js'
            wikipedia-search:
              - 'components/wikipedia-search.html'
              - 'tests/test-clm-wikipedia-search.spec.js'
            external-site-demo:
              - 'tests/test-clm-external-site-demo.spec.js'
            google-maps:
              - 'tests/test-clm-google-maps.spec.js'
            pkc-viewer:
              - 'components/pkc-viewer.html'
              - 'tests/test-clm-pkc-viewer.spec.js'
            grafana-faro:
              - 'components/grafana-faro.html'
              - 'tests/test-clm-grafana-faro.spec.js'
            youtube-viewer:
              - 'components/youtube-viewer.html'
              - 'tests/test-clm-youtube-viewer.spec.js'

  test-components:
    needs: detect-changes
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        component:
          - hash: welcome
            name: Welcome Component
            file: components/welcome.html
            changed: ${{ needs.detect-changes.outputs.welcome }}
          - hash: hero-content
            name: Hero Content
            file: components/hero.html
            changed: ${{ needs.detect-changes.outputs.hero-content }}
          - hash: p2p-status
            name: P2P Network Status
            file: components/p2p-status.html
            changed: ${{ needs.detect-changes.outputs.p2p-status }}
          - hash: crash-test
            name: Intentional Failure Component
            file: components/crash-test.html
            changed: ${{ needs.detect-changes.outputs.crash-test }}
          - hash: wikipedia-viewer
            name: Wikipedia Article Viewer
            file: components/wikipedia-viewer.html
            changed: ${{ needs.detect-changes.outputs.wikipedia-viewer }}
          - hash: user-list
            name: User Account List
            file: components/user-list.html
            changed: ${{ needs.detect-changes.outputs.user-list }}
          - hash: user-detail
            name: User Account Detail
            file: components/user-detail.html
            changed: ${{ needs.detect-changes.outputs.user-detail }}
          - hash: redux-state-viewer
            name: Redux State Viewer
            file: components/redux-state-viewer.html
            changed: ${{ needs.detect-changes.outputs.redux-state-viewer }}
          - hash: wikipedia-search
            name: Wikipedia Search
            file: components/wikipedia-search.html
            changed: ${{ needs.detect-changes.outputs.wikipedia-search }}
          - hash: external-site-demo
            name: External Site Demo
            file: external
            changed: ${{ needs.detect-changes.outputs.external-site-demo }}
          - hash: google-maps
            name: Google Maps Demo
            file: external
            changed: ${{ needs.detect-changes.outputs.google-maps }}
          - hash: pkc-viewer
            name: PKC Document Viewer
            file: components/pkc-viewer.html
            changed: ${{ needs.detect-changes.outputs.pkc-viewer }}
          - hash: grafana-faro
            name: Grafana Faro Integration
            file: components/grafana-faro.html
            changed: ${{ needs.detect-changes.outputs.grafana-faro }}
          - hash: youtube-viewer
            name: YouTube Video Viewer
            file: components/youtube-viewer.html
            changed: ${{ needs.detect-changes.outputs.youtube-viewer }}

    name: Test ${{ matrix.component.name }}

    steps:
      - uses: actions/checkout@v4
        if: ${{ matrix.component.changed == 'true' }}

      - name: Setup Node.js
        if: ${{ matrix.component.changed == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Playwright Browsers
        if: ${{ matrix.component.changed == 'true' }}
        run: npx playwright install --with-deps chromium

      - name: Install Docker Compose
        if: ${{ matrix.component.changed == 'true' }}
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Start services
        if: ${{ matrix.component.changed == 'true' }}
        run: |
          docker-compose up -d
          echo "Waiting for services to be ready..."
          sleep 10
          docker-compose ps
        env:
          COMPOSE_PROJECT_NAME: landingpage-test

      - name: Run Playwright test for ${{ matrix.component.name }}
        if: ${{ matrix.component.changed == 'true' }}
        id: test
        continue-on-error: true
        run: npx playwright test tests/test-clm-${{ matrix.component.hash }}.spec.js --reporter=json
        env:
          CI: true

      - name: Save test results to JSON
        if: ${{ always() && matrix.component.changed == 'true' }}
        run: |
          mkdir -p tests/test-components
          
          cat > tests/test-components/${{ matrix.component.hash }}.json << EOF
          {
            "hash": "${{ matrix.component.hash }}",
            "name": "${{ matrix.component.name }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "test_run": ${{ github.run_number }},
            "status": "${{ steps.test.outcome == 'success' && 'success' || 'failure' }}",
            "github_actions_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "actor": "${{ github.actor }}"
          }
          EOF
          
          echo "âœ… Test results saved to tests/test-components/${{ matrix.component.hash }}.json"
          cat tests/test-components/${{ matrix.component.hash }}.json

      - name: Commit and Push results
        if: ${{ always() && matrix.component.changed == 'true' }}
        run: |
          chmod +x .github/scripts/push-test-results.sh
          .github/scripts/push-test-results.sh \
            "${{ matrix.component.hash }}" \
            "${{ github.run_number }}" \
            "${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.repository }}" \
            "${{ github.ref }}"

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: ${{ always() && matrix.component.changed == 'true' }}
        with:
          name: ${{ matrix.component.hash }}-screenshots
          path: tests/test-results/*.png
          retention-days: 7
          
      - name: Stop services
        if: ${{ always() && matrix.component.changed == 'true' }}
        run: docker-compose down -v

      - name: Test Summary
        if: ${{ always() && matrix.component.changed == 'true' }}
        run: |
          echo "### CLM Component Test Summary - ${{ matrix.component.name }} ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Component**: ${{ matrix.component.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Hash**: ${{ matrix.component.hash }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.test.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Run**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š [View detailed results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

  deploy-to-test:
    needs: test-components
    runs-on: ubuntu-latest
    if: ${{ always() && github.ref == 'refs/heads/main' }}
    name: Deploy to test.pkc.pub
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Trigger ArgoCD Sync
        run: |
          echo "### ðŸš€ Deploying to test.pkc.pub" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: Deployment triggered via ArgoCD" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: https://test.pkc.pub" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will automatically sync the cluster to match the Git state." >> $GITHUB_STEP_SUMMARY
          echo "Tests do not need to pass for deployment - this is a continuous deployment environment." >> $GITHUB_STEP_SUMMARY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: test.pkc.pub" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: [${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: This deployment runs regardless of test results. ArgoCD will continuously sync the cluster." >> $GITHUB_STEP_SUMMARY

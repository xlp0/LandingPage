<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THK Mesh - Local First</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Redux from CDN -->
    <script crossorigin src="https://unpkg.com/redux@4/dist/redux.js"></script>
    <script crossorigin src="https://unpkg.com/@reduxjs/toolkit@1.9.7/dist/redux-toolkit.umd.js"></script>
    <!-- Local modules -->
    <script src="./js/local-storage-manager.js"></script>
    <script src="./js/oauth-handler.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #ffd700;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.6s ease-in-out;
        }
        
        .nav-button {
            transition: all 0.3s ease;
        }
        
        .nav-button:hover {
            transform: scale(1.05);
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #10b981;
            animation: pulse 2s infinite;
        }
        
        .status-offline {
            background-color: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .card:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-4px);
        }
    </style>
</head>
<body class="text-white font-sans">
    <!-- Navigation Bar -->
    <nav class="fixed top-0 left-0 right-0 bg-black/20 backdrop-blur-md border-b border-white/10 z-40">
        <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold">THK Mesh</div>
            <div class="flex gap-4 items-center">
                <button onclick="app.navigate('home')" class="nav-button px-4 py-2 rounded-lg hover:bg-white/10">Home</button>
                <button onclick="app.navigate('features')" class="nav-button px-4 py-2 rounded-lg hover:bg-white/10">Features</button>
                <button onclick="app.navigate('about')" class="nav-button px-4 py-2 rounded-lg hover:bg-white/10">About</button>
                <div id="auth-button-container">
                    <button onclick="app.login()" class="nav-button px-6 py-2 bg-white text-purple-600 rounded-lg font-semibold hover:bg-white/90">Login</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Status Bar -->
    <div class="fixed bottom-4 right-4 bg-black/40 backdrop-blur-md border border-white/20 rounded-lg px-4 py-2 text-sm z-40">
        <span class="status-indicator" id="status-dot"></span>
        <span id="status-text">Offline Mode</span>
    </div>

    <!-- Storage Info Panel -->
    <div class="fixed bottom-4 left-4 bg-black/40 backdrop-blur-md border border-white/20 rounded-lg px-4 py-2 text-xs z-40 max-w-xs">
        <div class="font-semibold mb-2">Local Storage</div>
        <div id="storage-info" class="opacity-75">Initializing...</div>
    </div>

    <!-- Main Content Area -->
    <div class="pt-20 pb-8">
        <!-- Home Page -->
        <div id="page-home" class="page active">
            <div class="max-w-6xl mx-auto px-6 py-16 text-center">
                <h1 class="text-6xl font-bold mb-6 fade-in">Welcome to THK Mesh</h1>
                <p class="text-2xl mb-8 opacity-90 fade-in">A local-first, decentralized collaboration platform</p>
                <p class="text-lg mb-12 opacity-75 max-w-2xl mx-auto fade-in">
                    Start exploring locally. Connect globally. All your data stays with you.
                </p>
                <div class="flex gap-4 justify-center flex-wrap fade-in">
                    <button onclick="app.navigate('features')" class="px-8 py-3 bg-white text-purple-600 rounded-lg font-semibold hover:bg-white/90 transition">Explore Features</button>
                    <button onclick="app.login()" class="px-8 py-3 border-2 border-white text-white rounded-lg font-semibold hover:bg-white/10 transition">Sign In</button>
                </div>
                
                <!-- Quick Start Section -->
                <div class="mt-16 grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                    <div class="card fade-in">
                        <div class="text-3xl mb-3">üìù</div>
                        <h3 class="font-bold mb-2">Create Locally</h3>
                        <p class="text-sm opacity-75">Start creating documents right now, all stored locally in your browser.</p>
                    </div>
                    <div class="card fade-in">
                        <div class="text-3xl mb-3">üîó</div>
                        <h3 class="font-bold mb-2">Connect P2P</h3>
                        <p class="text-sm opacity-75">Share with others directly without a central server.</p>
                    </div>
                    <div class="card fade-in">
                        <div class="text-3xl mb-3">‚òÅÔ∏è</div>
                        <h3 class="font-bold mb-2">Sync Optional</h3>
                        <p class="text-sm opacity-75">Optionally sync to the cloud when you're ready.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Page -->
        <div id="page-features" class="page">
            <div class="max-w-6xl mx-auto px-6 py-16">
                <h1 class="text-5xl font-bold mb-12 text-center fade-in">Features</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="card fade-in">
                        <h3 class="text-xl font-bold mb-3">üì± Local First</h3>
                        <p class="opacity-90">All data is stored locally in your browser. Work offline without any limitations.</p>
                    </div>
                    <div class="card fade-in">
                        <h3 class="text-xl font-bold mb-3">üîó P2P Ready</h3>
                        <p class="opacity-90">Connect peer-to-peer with others. No central server required for collaboration.</p>
                    </div>
                    <div class="card fade-in">
                        <h3 class="text-xl font-bold mb-3">üîê Secure</h3>
                        <p class="opacity-90">End-to-end encryption. Your data is yours. Optional cloud sync with authentication.</p>
                    </div>
                    <div class="card fade-in">
                        <h3 class="text-xl font-bold mb-3">‚ö° Fast</h3>
                        <p class="opacity-90">No network latency for local operations. Instant response times.</p>
                    </div>
                    <div class="card fade-in">
                        <h3 class="text-xl font-bold mb-3">üé® Modular</h3>
                        <p class="opacity-90">Extensible architecture. Add features as needed without bloat.</p>
                    </div>
                    <div class="card fade-in">
                        <h3 class="text-xl font-bold mb-3">üåê Open</h3>
                        <p class="opacity-90">Open source. Community-driven. Transparent development.</p>
                    </div>
                </div>
                <div class="mt-12 text-center">
                    <button onclick="app.navigate('home')" class="px-6 py-2 border-2 border-white text-white rounded-lg font-semibold hover:bg-white/10 transition">Back to Home</button>
                </div>
            </div>
        </div>

        <!-- About Page -->
        <div id="page-about" class="page">
            <div class="max-w-4xl mx-auto px-6 py-16">
                <h1 class="text-5xl font-bold mb-8 text-center fade-in">About THK Mesh</h1>
                <div class="card fade-in">
                    <h2 class="text-2xl font-bold mb-4">Our Vision</h2>
                    <p class="mb-6 opacity-90 leading-relaxed">
                        THK Mesh is built on the principle that users should have complete control over their data. We believe in a future where collaboration happens peer-to-peer, where privacy is the default, and where you're never locked into a single platform.
                    </p>
                    <h2 class="text-2xl font-bold mb-4 mt-8">Local-First Architecture</h2>
                    <p class="mb-6 opacity-90 leading-relaxed">
                        Every feature is designed to work offline first. Your browser becomes your personal knowledge container. When you're ready to collaborate, you can optionally connect to others or sync to the cloud.
                    </p>
                    <h2 class="text-2xl font-bold mb-4 mt-8">Getting Started</h2>
                    <p class="mb-4 opacity-90 leading-relaxed">
                        You can start using THK Mesh right now, completely offline. All your data is stored locally in your browser's storage. When you're ready to sync or collaborate, simply log in with your account.
                    </p>
                    <h2 class="text-2xl font-bold mb-4 mt-8">Authentication</h2>
                    <p class="mb-4 opacity-90 leading-relaxed">
                        We use Zitadel for secure authentication. When you log in, you transition from the local static environment to a server-based environment where you can sync and collaborate with others.
                    </p>
                </div>
                <div class="mt-12 text-center">
                    <button onclick="app.navigate('home')" class="px-6 py-2 border-2 border-white text-white rounded-lg font-semibold hover:bg-white/10 transition">Back to Home</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get local modules from window
        const LocalStorageManager = window.LocalStorageManager;
        const OAuth2Handler = window.OAuth2Handler;
        
        // Redux from CDN globals
        const { configureStore, createSlice } = window.RTK;

        // Initialize managers
        const storage = new LocalStorageManager({
            prefix: 'thk-mesh-',
            debug: true
        });

        const oauth = new OAuth2Handler({
            domain: 'vpn.pkc.pub',
            clientId: '348213051452882951',
            redirectUri: window.location.origin + '/auth-callback-enhanced.html',
            debug: true
        });

        // Create Redux Auth Slice inline
        const authSlice = createSlice({
            name: 'auth',
            initialState: {
                isAuthenticated: false,
                user: null,
                token: null,
                refreshToken: null,
                loading: false,
                error: null,
                loginMethod: null,
            },
            reducers: {
                setAuth: (state, action) => {
                    state.isAuthenticated = action.payload.isAuthenticated;
                    state.user = action.payload.user;
                    state.token = action.payload.token;
                    state.refreshToken = action.payload.refreshToken;
                    state.loginMethod = action.payload.loginMethod;
                },
                clearAuth: (state) => {
                    state.isAuthenticated = false;
                    state.user = null;
                    state.token = null;
                    state.refreshToken = null;
                    state.loginMethod = null;
                },
                setLoading: (state, action) => {
                    state.loading = action.payload;
                },
                setError: (state, action) => {
                    state.error = action.payload;
                },
            },
        });

        // Create Redux Connection Slice inline
        const connectionSlice = createSlice({
            name: 'connection',
            initialState: {
                peers: {},
                localStream: null,
                audioEnabled: true,
                videoEnabled: true,
                screenSharing: false,
                connectionStatus: 'idle',
                error: null,
            },
            reducers: {
                addPeer: (state, action) => {
                    state.peers[action.payload.peerId] = action.payload;
                },
                removePeer: (state, action) => {
                    delete state.peers[action.payload];
                },
            },
        });

        // Create Redux Store
        const store = configureStore({
            reducer: {
                auth: authSlice.reducer,
                connection: connectionSlice.reducer,
            },
            middleware: (getDefaultMiddleware) =>
                getDefaultMiddleware({
                    serializableCheck: false,
                }),
        });

        // Selectors
        const selectIsAuthenticated = (state) => state.auth.isAuthenticated;
        const selectUser = (state) => state.auth.user;
        const selectUserName = (state) => state.auth.user?.name;
        const selectAuthLoading = (state) => state.auth.loading;

        // Application State Manager
        window.app = {
            currentPage: 'home',
            isOnline: navigator.onLine,
            storage: storage,
            oauth: oauth,
            store: store,
            unsubscribe: null,

            init() {
                try {
                    storage.init();
                    this.setupEventListeners();
                    this.updateStatus();
                    this.updateStorageInfo();
                    
                    // Verify store exists
                    if (!store || !store.getState) {
                        throw new Error('Redux store not initialized');
                    }

                    // Restore auth from localStorage
                    const user = storage.getUser();
                    const token = localStorage.getItem('auth_token');
                    const refreshToken = localStorage.getItem('refresh_token');
                    
                    console.log('[App] Checking localStorage for auth data...');
                    console.log('[App] User:', user);
                    console.log('[App] Token:', token ? 'exists' : 'not found');
                    
                    if (user && (token || user.authenticated)) {
                        console.log('[App] Restoring auth from localStorage');
                        store.dispatch(authSlice.actions.setAuth({
                            isAuthenticated: true,
                            user: user,
                            token: token || user.code,
                            refreshToken: refreshToken,
                            loginMethod: 'zitadel'
                        }));
                        console.log('[App] Auth restored to Redux store');
                        console.log('[App] Redux state:', store.getState().auth);
                    } else {
                        console.log('[App] No auth data found in localStorage');
                    }

                    // Subscribe to Redux store changes
                    this.unsubscribe = store.subscribe(() => {
                        this.updateAuthUI();
                    });

                    // Initial UI update
                    this.updateAuthUI();

                    console.log('[App] Initialized with Redux store');
                } catch (error) {
                    console.error('[App] Initialization error:', error);
                    this.updateAuthUI();
                }
            },

            setupEventListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateStatus();
                    console.log('[App] Online');
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateStatus();
                    console.log('[App] Offline');
                });

                // Update storage info periodically
                setInterval(() => this.updateStorageInfo(), 5000);
            },

            updateStatus() {
                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                
                if (this.isOnline) {
                    statusDot.className = 'status-indicator status-online';
                    statusText.textContent = 'Online';
                } else {
                    statusDot.className = 'status-indicator status-offline';
                    statusText.textContent = 'Offline Mode';
                }
            },

            updateStorageInfo() {
                const size = storage.getSize();
                const keys = storage.keys().length;
                const sizeKB = (size / 1024).toFixed(2);
                document.getElementById('storage-info').innerHTML = `
                    Items: ${keys}<br>
                    Size: ${sizeKB} KB
                `;
            },

            updateAuthUI() {
                const state = store.getState();
                const isAuthenticated = selectIsAuthenticated(state);
                const user = selectUser(state);
                const userName = selectUserName(state);
                const isLoading = selectAuthLoading(state);
                const authButton = document.getElementById('auth-button-container');
                
                if (isLoading) {
                    authButton.innerHTML = `
                        <button class="nav-button px-6 py-2 bg-white text-purple-600 rounded-lg font-semibold opacity-50 cursor-not-allowed">
                            Loading...
                        </button>
                    `;
                } else if (isAuthenticated && user) {
                    authButton.innerHTML = `
                        <div class="flex gap-2 items-center">
                            <div class="flex items-center gap-2">
                                ${user.avatar ? `<img src="${user.avatar}" alt="${userName}" class="w-8 h-8 rounded-full">` : '<div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-xs">üë§</div>'}
                                <span class="text-sm opacity-90">${userName || 'User'}</span>
                            </div>
                            <button onclick="app.logout()" class="nav-button px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition">
                                Logout
                            </button>
                        </div>
                    `;
                    console.log('[App] User authenticated via Redux:', userName);
                } else {
                    authButton.innerHTML = `
                        <button onclick="app.login()" class="nav-button px-6 py-2 bg-white text-purple-600 rounded-lg font-semibold hover:bg-white/90 transition">
                            Login
                        </button>
                    `;
                }
            },

            navigate(page) {
                // Hide all pages
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                
                // Show selected page
                const pageElement = document.getElementById(`page-${page}`);
                if (pageElement) {
                    pageElement.classList.add('active');
                    this.currentPage = page;
                    console.log(`[App] Navigated to: ${page}`);
                }
            },

            async login() {
                // Redirect to Zitadel login
                console.log('[App] Initiating login flow...');
                await oauth.redirectToLogin();
            },

            logout() {
                console.log('[App] Logout initiated');
                try {
                    // Dispatch logout action
                    store.dispatch(authSlice.actions.clearAuth());
                    storage.clearUser();
                    this.updateAuthUI();
                    this.navigate('home');
                    console.log('[App] Logged out from Redux store');
                } catch (error) {
                    console.error('[App] Logout exception:', error);
                    storage.clearUser();
                    this.updateAuthUI();
                    this.navigate('home');
                }
            }
        };

        // Exchange authorization code for real user data
        async function exchangeCodeForToken() {
            const code = localStorage.getItem('auth_code');
            const codeVerifier = localStorage.getItem('pkce_code_verifier');
            const user = storage.getUser();
            
            // Only exchange if we have a code and haven't already done so
            if (!code || !user?.requiresBackendExchange) {
                console.log('[App] No code to exchange or already exchanged');
                return;
            }
            
            try {
                console.log('[App] Exchanging authorization code for real user data...');
                console.log('[App] Code verifier:', codeVerifier ? 'present' : 'missing');
                
                const response = await fetch('/api/auth/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: code,
                        codeVerifier: codeVerifier,
                        redirectUri: window.location.origin + '/auth-callback-enhanced.html'
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.details || `Backend returned ${response.status}`);
                }
                
                const data = await response.json();
                
                console.log('[App] Real user data received:', data.user);
                
                // Update Redux store with REAL user data
                store.dispatch(authSlice.actions.setAuth({
                    isAuthenticated: true,
                    user: data.user,
                    token: data.token,
                    refreshToken: data.refreshToken,
                    loginMethod: 'zitadel'
                }));
                
                // Update localStorage
                localStorage.setItem('auth_token', data.token);
                localStorage.setItem('refresh_token', data.refreshToken);
                storage.setUser(data.user);
                
                // Remove the code since we've used it
                localStorage.removeItem('auth_code');
                
                console.log('[App] Redux store updated with real user data');
                console.log('[App] Redux auth state:', store.getState().auth);
            } catch (error) {
                console.error('[App] Token exchange failed:', error);
                // Keep temporary data if exchange fails
            }
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
            // Exchange code for real user data after a short delay
            setTimeout(() => {
                exchangeCodeForToken();
            }, 500);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (app.unsubscribe) {
                app.unsubscribe();
            }
        });
    </script>
</body>
</html>

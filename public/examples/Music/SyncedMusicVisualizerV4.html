<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synchronized Music Visualizer V4 - Web Workers Edition</title>
    
    <!-- Libraries (locally served) -->
    <script src="./js/lib/opensheetmusicdisplay.min.js"></script>
    <script src="./js/lib/Tone.min.js"></script>
    <script src="./js/lib/redux.min.js"></script>
    <script src="./js/lib/three.min.js"></script>
    <script src="./js/lib/OrbitControls.js"></script>
    <script src="./js/lib/anime.min.js"></script>
    <script src="./css/tailwind.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        #three-container { position: relative; }
        #three-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #osmd-container { background: white; min-height: 300px; overflow-x: auto; position: relative; }
        /* OSMD Cursor visibility - fix z-index */
        #osmd-container img { z-index: 10 !important; }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-400 bg-clip-text text-transparent mb-2">
                üéº Music Visualizer V4
            </h1>
            <p class="text-slate-400 text-lg">High-Performance with Web Workers + OffscreenCanvas</p>
            <div class="mt-2 flex items-center justify-center gap-2 text-xs text-slate-500">
                <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">‚ö° Web Workers</span>
                <span class="px-2 py-1 bg-blue-500/20 text-blue-400 rounded">üé® OffscreenCanvas</span>
                <span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded">üìä Performance Metrics</span>
            </div>
        </header>

        <!-- Song Selector -->
        <div id="songSelector" class="flex flex-wrap gap-3 justify-center mb-6"></div>

        <!-- Status Bar -->
        <div id="statusBar" class="text-center py-3 px-4 bg-slate-800/50 rounded-lg text-slate-400 mb-6 backdrop-blur-sm">
            Select a song to begin
        </div>

        <!-- Performance Metrics -->
        <div id="perfMetrics" class="hidden mb-6 p-4 bg-slate-800/30 rounded-xl border border-slate-700/50 backdrop-blur-sm">
            <div class="text-xs font-medium text-slate-400 uppercase tracking-wide mb-3">‚ö° Performance Metrics</div>
            <div class="grid grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-400" id="metricRender">0ms</div>
                    <div class="text-xs text-slate-500 mt-1">OSMD Render</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400" id="metricWorker">0ms</div>
                    <div class="text-xs text-slate-500 mt-1">Worker Dispatch</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-400" id="metricTotal">0ms</div>
                    <div class="text-xs text-slate-500 mt-1">Total Load Time</div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            
            <!-- Music Sheet Panel -->
            <div class="bg-slate-800/40 rounded-2xl border border-slate-700/50 backdrop-blur-sm">
                <div class="px-5 py-3 bg-slate-800/60 border-b border-slate-700/50">
                    <span class="text-sm font-medium text-slate-400 uppercase tracking-wide">üìÑ Sheet Music</span>
                </div>
                <div id="osmd-container" class="p-6">
                    <div class="flex flex-col items-center justify-center h-64 text-slate-500">
                        <span class="text-5xl mb-4">üéµ</span>
                        <span>Sheet music will appear here</span>
                    </div>
                </div>
            </div>

            <!-- 3D Visualization Panel -->
            <div class="bg-slate-800/40 rounded-2xl overflow-hidden border border-slate-700/50 backdrop-blur-sm">
                <div class="px-5 py-3 bg-slate-800/60 border-b border-slate-700/50">
                    <span class="text-sm font-medium text-slate-400 uppercase tracking-wide">üåê 3D Visualization</span>
                </div>
                <div id="three-container" class="h-80 relative">
                    <canvas id="three-canvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex items-center justify-center gap-4 p-5 bg-slate-800/40 rounded-2xl backdrop-blur-sm border border-slate-700/50">
            <button id="stopBtn" class="w-14 h-14 rounded-full bg-slate-700/50 border-2 border-slate-600 hover:bg-slate-600/50 transition-all flex items-center justify-center group">
                <svg class="w-5 h-5 fill-current text-slate-300 group-hover:text-white" viewBox="0 0 24 24">
                    <rect x="6" y="6" width="12" height="12" />
                </svg>
            </button>
            
            <button id="playBtn" disabled class="w-16 h-16 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 border-2 border-purple-400 hover:from-purple-400 hover:to-pink-400 transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-purple-500/30">
                <svg id="play-icon" class="w-6 h-6 fill-current text-white ml-1" viewBox="0 0 24 24">
                    <polygon points="8 5 19 12 8 19 8 5" />
                </svg>
                <svg id="pause-icon" class="w-6 h-6 fill-current text-white hidden" viewBox="0 0 24 24">
                    <rect x="6" y="4" width="4" height="16" />
                    <rect x="14" y="4" width="4" height="16" />
                </svg>
            </button>

            <div class="ml-4 pl-4 border-l border-slate-600 text-center">
                <div id="currentTime" class="font-mono text-2xl text-cyan-400">00:00</div>
                <div class="font-mono text-sm text-slate-500">/ <span id="totalTime">00:00</span></div>
            </div>
        </div>
    </div>

    <!-- Application Scripts -->
    <script src="./songs-data.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/store.js"></script>
    <script src="./js/AudioEngineV4.js"></script>
    
    <script>
        // --- THREE.JS 3D VISUALIZER ---
        class ThreeVisualizer {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.canvas = document.getElementById('three-canvas');
                this.bars = [];
                this.init();
            }

            init() {
                const width = this.container.clientWidth;
                const height = this.container.clientHeight;

                // Scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x0f172a);

                // Camera
                this.camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
                this.camera.position.set(0, 20, 35);
                this.camera.lookAt(0, 5, 0);

                // Renderer
                this.renderer = new THREE.WebGLRenderer({ canvas: this.canvas, antialias: true });
                this.renderer.setSize(width, height);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
                this.scene.add(ambientLight);

                const pointLight = new THREE.PointLight(0xffffff, 1);
                pointLight.position.set(10, 20, 10);
                this.scene.add(pointLight);

                // Create bars
                this.createBars(32);

                // Ground plane
                const groundGeometry = new THREE.PlaneGeometry(50, 50);
                const groundMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x1e293b,
                    metalness: 0.8,
                    roughness: 0.4
                });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.position.y = -0.1;
                this.scene.add(ground);

                // OrbitControls for camera interaction
                this.controls = new THREE.OrbitControls(this.camera, this.canvas);
                this.controls.target.set(0, 5, 0);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                this.controls.minDistance = 15;
                this.controls.maxDistance = 80;
                this.controls.maxPolarAngle = Math.PI / 2;
                this.controls.autoRotate = false;
                this.controls.update();

                // Handle resize
                window.addEventListener('resize', () => this.onResize());

                // Start animation loop
                this.animate();
            }

            createBars(count) {
                const barWidth = 0.8;
                const gap = 0.4;
                const totalWidth = count * (barWidth + gap);
                const startX = -totalWidth / 2;

                for (let i = 0; i < count; i++) {
                    const geometry = new THREE.BoxGeometry(barWidth, 1, barWidth);
                    const hue = (i / count) * 0.3 + 0.5; // Purple to cyan range
                    const material = new THREE.MeshStandardMaterial({
                        color: new THREE.Color().setHSL(hue, 0.8, 0.5),
                        metalness: 0.3,
                        roughness: 0.4,
                        emissive: new THREE.Color().setHSL(hue, 0.8, 0.2)
                    });
                    const bar = new THREE.Mesh(geometry, material);
                    bar.position.x = startX + i * (barWidth + gap);
                    bar.position.y = 0.5;
                    this.scene.add(bar);
                    this.bars.push(bar);
                }
            }

            updateBars(fftData) {
                if (!fftData || fftData.length === 0) return;

                const barCount = this.bars.length;
                for (let i = 0; i < barCount; i++) {
                    const dataIndex = Math.floor((i / barCount) * fftData.length);
                    const db = fftData[dataIndex];
                    const value = Math.max(0.1, (db + 100) / 100);
                    const targetHeight = value * 15;

                    // Animate with anime.js for smooth transitions
                    anime({
                        targets: this.bars[i].scale,
                        y: targetHeight,
                        duration: 100,
                        easing: 'easeOutQuad'
                    });

                    // Update emissive based on intensity
                    const hue = (i / barCount) * 0.3 + 0.5;
                    this.bars[i].material.emissive.setHSL(hue, 0.8, value * 0.3);
                }
            }

            onResize() {
                const width = this.container.clientWidth;
                const height = this.container.clientHeight;
                this.camera.aspect = width / height;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(width, height);
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                this.controls.update(); // Required for damping
                this.renderer.render(this.scene, this.camera);
            }
        }

        // --- UI MANAGER V4 ---
        class UIManagerV4 {
            constructor(store, audioEngine, threeVisualizer) {
                this.store = store;
                this.audioEngine = audioEngine;
                this.threeVisualizer = threeVisualizer;

                // DOM Elements
                this.elSongSelector = document.getElementById('songSelector');
                this.elStatusBar = document.getElementById('statusBar');
                this.elPlayBtn = document.getElementById('playBtn');
                this.elStopBtn = document.getElementById('stopBtn');
                this.elTimeCurrent = document.getElementById('currentTime');
                this.elTimeTotal = document.getElementById('totalTime');
                this.playIcon = document.getElementById('play-icon');
                this.pauseIcon = document.getElementById('pause-icon');
                this.elPerfMetrics = document.getElementById('perfMetrics');
                this.elMetricRender = document.getElementById('metricRender');
                this.elMetricWorker = document.getElementById('metricWorker');
                this.elMetricTotal = document.getElementById('metricTotal');

                this.store.subscribe(() => this.render());

                this.initSongList();
                this.bindEvents();
                this.startVisualizationLoop();
                this.startPerformanceMonitoring();
            }

            initSongList() {
                Object.keys(SONGS_DATA).forEach(key => {
                    const song = SONGS_DATA[key];
                    const btn = document.createElement('button');
                    btn.className = 'px-5 py-2.5 rounded-full bg-slate-700/50 border border-slate-600 text-sm font-medium hover:bg-slate-600/50 hover:-translate-y-0.5 transition-all';
                    btn.textContent = song.title;
                    btn.onclick = () => {
                        // Animate button press
                        anime({
                            targets: btn,
                            scale: [1, 0.95, 1],
                            duration: 200,
                            easing: 'easeInOutQuad'
                        });
                        this.audioEngine.loadSong(key);
                    };
                    this.elSongSelector.appendChild(btn);
                });
            }

            bindEvents() {
                this.elPlayBtn.onclick = () => this.audioEngine.togglePlay();
                this.elStopBtn.onclick = () => this.audioEngine.stop();
            }

            render() {
                const state = this.store.getState();
                const { playback, song } = state;

                // Status Bar
                if (song.isLoading) {
                    this.elStatusBar.textContent = `Loading "${song.title}"...`;
                } else if (song.error) {
                    this.elStatusBar.textContent = `Error: ${song.error}`;
                } else if (playback.isPlaying) {
                    this.elStatusBar.textContent = `Playing: "${song.title}"`;
                } else if (song.currentSongId) {
                    this.elStatusBar.textContent = `Ready: "${song.title}" by ${song.composer || 'Unknown'}`;
                } else {
                    this.elStatusBar.textContent = 'Select a song to begin';
                }

                // Play Button
                this.elPlayBtn.disabled = !song.currentSongId || song.isLoading;
                this.playIcon.classList.toggle('hidden', playback.isPlaying);
                this.pauseIcon.classList.toggle('hidden', !playback.isPlaying);

                // Time Display
                this.elTimeCurrent.textContent = this.formatTime(playback.currentTime);
                this.elTimeTotal.textContent = this.formatTime(playback.duration);

                // Song Buttons
                Array.from(this.elSongSelector.children).forEach(btn => {
                    const isSelected = btn.textContent === song.title;
                    btn.classList.toggle('bg-gradient-to-r', isSelected);
                    btn.classList.toggle('from-cyan-500', isSelected);
                    btn.classList.toggle('to-purple-500', isSelected);
                    btn.classList.toggle('border-cyan-400', isSelected);
                    btn.classList.toggle('shadow-lg', isSelected);
                    btn.classList.toggle('shadow-cyan-500/30', isSelected);
                });
            }

            formatTime(seconds) {
                const min = Math.floor(seconds / 60).toString().padStart(2, '0');
                const sec = Math.floor(seconds % 60).toString().padStart(2, '0');
                return `${min}:${sec}`;
            }

            startVisualizationLoop() {
                const animate = () => {
                    const fft = this.audioEngine.getFFT();
                    if (fft) {
                        const values = fft.getValue();
                        this.threeVisualizer.updateBars(values);
                    }
                    requestAnimationFrame(animate);
                };
                animate();
            }

            startPerformanceMonitoring() {
                setInterval(() => {
                    if (this.audioEngine.metrics) {
                        const metrics = this.audioEngine.metrics;
                        if (metrics.renderTime > 0) {
                            this.elPerfMetrics.classList.remove('hidden');
                            this.elMetricRender.textContent = `${metrics.renderTime.toFixed(1)}ms`;
                            this.elMetricWorker.textContent = `${metrics.workerTime.toFixed(1)}ms`;
                            this.elMetricTotal.textContent = `${(metrics.renderTime + metrics.workerTime).toFixed(1)}ms`;
                        }
                    }
                }, 100);
            }
        }

        // --- BOOTSTRAP V4 ---
        async function bootstrap() {
            if (window.app) return;

            const threeVisualizer = new ThreeVisualizer('three-container');
            
            const audioEngine = new AudioEngineV4(MusicStore, MusicVisualizerConfig);
            await audioEngine.initAudio();

            const uiManager = new UIManagerV4(MusicStore, audioEngine, threeVisualizer);

            window.app = { 
                store: MusicStore, 
                audioEngine, 
                uiManager,
                threeVisualizer,
                config: MusicVisualizerConfig
            };
            
            console.log("‚ú® V4 App Bootstrapped - Web Workers + Performance Monitoring enabled");
        }

        if (document.readyState === 'loading') {
            window.addEventListener('DOMContentLoaded', bootstrap);
        } else {
            bootstrap();
        }
    </script>
</body>

</html>

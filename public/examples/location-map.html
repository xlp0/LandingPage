<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Location Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
        }
        
        .location-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
        }
        
        .location-info h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }
        
        .location-info p {
            font-size: 13px;
            color: #666;
            margin: 5px 0;
        }
        
        .user-count {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: 600;
            font-size: 14px;
        }
        
        .permission-prompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            text-align: center;
            max-width: 400px;
        }
        
        .permission-prompt h2 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .permission-prompt p {
            margin-bottom: 20px;
            color: #666;
            line-height: 1.5;
        }
        
        .permission-prompt button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .permission-prompt button:hover {
            background: #5568d3;
        }
        
        .permission-prompt button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .error-message {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff6b6b;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        
        .user-list {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 250px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .user-list h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }
        
        .user-item {
            padding: 8px;
            margin: 5px 0;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .user-name {
            font-weight: 600;
            color: #333;
        }
        
        .user-distance {
            color: #666;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="user-count" id="userCount">
        üë• <span id="userCountNumber">0</span> users online
    </div>
    
    <div class="permission-prompt" id="permissionPrompt">
        <h2>üìç Enable Location Sharing</h2>
        <p>This app needs your location permission to show you on the map and share your location with other users in real-time.</p>
        <button id="enableLocationBtn">Enable Location</button>
    </div>
    
    <div class="location-info" id="locationInfo" style="display: none;">
        <h3>üìç Your Location</h3>
        <p><strong>Device:</strong> <span id="deviceName">Unknown</span></p>
        <p><strong>Latitude:</strong> <span id="latitude">-</span></p>
        <p><strong>Longitude:</strong> <span id="longitude">-</span></p>
        <p><strong>Accuracy:</strong> <span id="accuracy">-</span>m</p>
        <p><strong>Last Updated:</strong> <span id="lastUpdate">-</span></p>
    </div>
    
    <div class="user-list" id="userList" style="display: none;">
        <h4>Active Users</h4>
        <div id="userListContent"></div>
    </div>
    
    <div class="error-message" id="errorMessage"></div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Configuration - Auto-detect WebSocket protocol based on page protocol
        const WS_PROTOCOL = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        // Build WebSocket URL - use hostname and port from current page
        // If no port specified, browser will use default (443 for wss, 80 for ws)
        const WS_URL = window.location.port 
            ? `${WS_PROTOCOL}//${window.location.hostname}:${window.location.port}/ws/`
            : `${WS_PROTOCOL}//${window.location.hostname}/ws/`;
        
        console.log('WebSocket URL:', WS_URL); // Debug log
        
        const LOCATION_CHANNEL = 'location-sharing';
        const UPDATE_INTERVAL = 5000; // Update location every 5 seconds
        
        // State
        let map;
        let ws;
        let myLocation = null;
        let myMarker = null;
        let userMarkers = new Map();
        let watchId = null;
        let deviceId = generateDeviceId();
        let deviceName = getDeviceName();
        let locationHistory = [];
        
        // Initialize
        document.getElementById('enableLocationBtn').addEventListener('click', requestLocationPermission);
        
        // Generate unique device ID
        function generateDeviceId() {
            let id = localStorage.getItem('deviceId');
            if (!id) {
                id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', id);
            }
            return id;
        }
        
        // Get device name
        function getDeviceName() {
            const stored = localStorage.getItem('deviceName');
            if (stored) return stored;
            
            const ua = navigator.userAgent;
            let name = 'Unknown Device';
            
            if (/iPhone/i.test(ua)) name = 'iPhone';
            else if (/iPad/i.test(ua)) name = 'iPad';
            else if (/Android/i.test(ua)) name = 'Android Device';
            else if (/Mac/i.test(ua)) name = 'Mac';
            else if (/Windows/i.test(ua)) name = 'Windows PC';
            else if (/Linux/i.test(ua)) name = 'Linux PC';
            
            // Add browser info
            if (/Chrome/i.test(ua)) name += ' (Chrome)';
            else if (/Safari/i.test(ua)) name += ' (Safari)';
            else if (/Firefox/i.test(ua)) name += ' (Firefox)';
            
            localStorage.setItem('deviceName', name);
            return name;
        }
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([0, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }
        
        // Request location permission
        async function requestLocationPermission() {
            const btn = document.getElementById('enableLocationBtn');
            btn.disabled = true;
            btn.textContent = 'Requesting...';
            
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by your browser');
                return;
            }
            
            try {
                // Request permission
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                
                // Permission granted
                document.getElementById('permissionPrompt').style.display = 'none';
                document.getElementById('locationInfo').style.display = 'block';
                document.getElementById('userList').style.display = 'block';
                
                initMap();
                connectWebSocket();
                startLocationTracking();
                
            } catch (error) {
                btn.disabled = false;
                btn.textContent = 'Enable Location';
                
                if (error.code === 1) {
                    showError('Location permission denied. Please enable location in your browser settings.');
                } else if (error.code === 2) {
                    showError('Location unavailable. Please check your device settings.');
                } else if (error.code === 3) {
                    showError('Location request timeout. Please try again.');
                } else {
                    showError('Error getting location: ' + error.message);
                }
            }
        }
        
        // Connect to WebSocket
        function connectWebSocket() {
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                // Subscribe to location channel
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    channel: LOCATION_CHANNEL
                }));
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                showError('Connection error. Retrying...');
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected. Reconnecting...');
                setTimeout(connectWebSocket, 3000);
            };
        }
        
        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            if (data.channel !== LOCATION_CHANNEL) return;
            
            if (data.type === 'location-update') {
                updateUserLocation(data);
            } else if (data.type === 'user-disconnected') {
                removeUser(data.deviceId);
            }
        }
        
        // Start location tracking
        function startLocationTracking() {
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    updateMyLocation(position);
                },
                (error) => {
                    console.error('Location tracking error:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        // Update my location
        function updateMyLocation(position) {
            const { latitude, longitude, accuracy } = position.coords;
            
            myLocation = {
                deviceId,
                deviceName,
                latitude,
                longitude,
                accuracy,
                timestamp: Date.now()
            };
            
            // Update UI
            document.getElementById('deviceName').textContent = deviceName;
            document.getElementById('latitude').textContent = latitude.toFixed(6);
            document.getElementById('longitude').textContent = longitude.toFixed(6);
            document.getElementById('accuracy').textContent = accuracy.toFixed(0);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // Update or create marker
            if (myMarker) {
                myMarker.setLatLng([latitude, longitude]);
            } else {
                myMarker = L.marker([latitude, longitude], {
                    icon: createCustomIcon('#667eea', true)
                }).addTo(map);
                
                myMarker.bindPopup(`
                    <strong>You</strong><br>
                    ${deviceName}<br>
                    Accuracy: ${accuracy.toFixed(0)}m
                `);
                
                map.setView([latitude, longitude], 13);
            }
            
            // Add to history
            locationHistory.push({
                latitude,
                longitude,
                timestamp: Date.now()
            });
            
            // Keep only last 100 positions
            if (locationHistory.length > 100) {
                locationHistory.shift();
            }
            
            // Broadcast to other users
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'location-update',
                    channel: LOCATION_CHANNEL,
                    deviceId,
                    deviceName,
                    latitude,
                    longitude,
                    accuracy,
                    timestamp: Date.now()
                }));
            }
        }
        
        // Update other user's location
        function updateUserLocation(data) {
            // Don't show our own location from broadcast
            if (data.deviceId === deviceId) return;
            
            const { latitude, longitude, deviceName, accuracy } = data;
            
            // Update or create marker
            if (userMarkers.has(data.deviceId)) {
                const marker = userMarkers.get(data.deviceId);
                marker.setLatLng([latitude, longitude]);
                marker.setPopupContent(`
                    <strong>${deviceName}</strong><br>
                    Accuracy: ${accuracy.toFixed(0)}m<br>
                    Updated: ${new Date().toLocaleTimeString()}
                `);
            } else {
                const color = getRandomColor();
                const marker = L.marker([latitude, longitude], {
                    icon: createCustomIcon(color, false)
                }).addTo(map);
                
                marker.bindPopup(`
                    <strong>${deviceName}</strong><br>
                    Accuracy: ${accuracy.toFixed(0)}m
                `);
                
                userMarkers.set(data.deviceId, marker);
            }
            
            updateUserList();
        }
        
        // Remove user
        function removeUser(deviceId) {
            if (userMarkers.has(deviceId)) {
                map.removeLayer(userMarkers.get(deviceId));
                userMarkers.delete(deviceId);
                updateUserList();
            }
        }
        
        // Create custom marker icon
        function createCustomIcon(color, isMe) {
            return L.divIcon({
                className: 'custom-marker',
                html: `
                    <div style="
                        width: ${isMe ? '20px' : '16px'};
                        height: ${isMe ? '20px' : '16px'};
                        background: ${color};
                        border: 3px solid white;
                        border-radius: 50%;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        ${isMe ? 'animation: pulse 2s infinite;' : ''}
                    "></div>
                    <style>
                        @keyframes pulse {
                            0%, 100% { transform: scale(1); }
                            50% { transform: scale(1.2); }
                        }
                    </style>
                `,
                iconSize: [isMe ? 20 : 16, isMe ? 20 : 16],
                iconAnchor: [isMe ? 10 : 8, isMe ? 10 : 8]
            });
        }
        
        // Get random color for user marker
        function getRandomColor() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7', '#fd79a8', '#fdcb6e', '#00b894'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // Update user list
        function updateUserList() {
            const count = userMarkers.size + (myLocation ? 1 : 0);
            document.getElementById('userCountNumber').textContent = count;
            
            const listContent = document.getElementById('userListContent');
            let html = '';
            
            // Add me
            if (myLocation) {
                html += `
                    <div class="user-item">
                        <div class="user-marker" style="background: #667eea;"></div>
                        <div>
                            <div class="user-name">You (${deviceName})</div>
                        </div>
                    </div>
                `;
            }
            
            // Add other users
            userMarkers.forEach((marker, deviceId) => {
                const popup = marker.getPopup();
                const content = popup ? popup.getContent() : '';
                const nameMatch = content.match(/<strong>(.*?)<\/strong>/);
                const name = nameMatch ? nameMatch[1] : 'Unknown';
                
                // Calculate distance if we have location
                let distance = '';
                if (myLocation) {
                    const userLatLng = marker.getLatLng();
                    const myLatLng = L.latLng(myLocation.latitude, myLocation.longitude);
                    const distanceMeters = myLatLng.distanceTo(userLatLng);
                    
                    if (distanceMeters < 1000) {
                        distance = `${distanceMeters.toFixed(0)}m away`;
                    } else {
                        distance = `${(distanceMeters / 1000).toFixed(1)}km away`;
                    }
                }
                
                html += `
                    <div class="user-item">
                        <div class="user-marker" style="background: ${getRandomColor()};"></div>
                        <div>
                            <div class="user-name">${name}</div>
                            ${distance ? `<div class="user-distance">${distance}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            listContent.innerHTML = html || '<p style="color: #999; font-size: 12px;">No other users online</p>';
        }
        
        // Show error message
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'user-disconnected',
                    channel: LOCATION_CHANNEL,
                    deviceId
                }));
                ws.close();
            }
        });
    </script>
</body>
</html>

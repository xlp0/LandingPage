<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKC Landing Page</title>
    <!-- Anime.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Redux from CDN -->
    <script crossorigin src="https://unpkg.com/redux@4/dist/redux.js"></script>
    <script crossorigin src="https://unpkg.com/@reduxjs/toolkit@1.9.7/dist/redux-toolkit.umd.js"></script>
    <!-- Local modules -->
    <script src="./js/local-storage-manager.js?v=4"></script>
    <script src="./js/oauth-handler.js?v=4"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'pkc-primary': '#667eea',
              'pkc-secondary': '#764ba2',
              'pkc-gold': '#ffd700'
            },
            animation: {
              'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite'
            }
          }
        }
      }
    </script>
    <style>
      /* Status dot colors - using Tailwind utilities directly in HTML */
    </style>
</head>
<body class="min-h-screen flex items-center justify-center font-sans text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <!-- Auth Status Bar -->
    <div id="auth-status-bar" class="fixed top-4 right-4 px-4 py-2 bg-black/30 backdrop-blur-md rounded-full border border-white/20 text-sm z-50 flex items-center gap-3">
      <span id="auth-user-info" class="hidden">
        <span id="auth-user-name" class="font-semibold"></span>
      </span>
      <button id="auth-button" onclick="app.login()" class="px-4 py-1.5 bg-white text-pkc-primary rounded-full font-semibold hover:bg-white/90 transition-colors">
        Login
      </button>
    </div>
    
    <div class="max-w-4xl mx-auto px-8 py-16 text-center" data-anime="main-content">
      <p id="pkc-title-text" class="text-xl md:text-2xl font-semibold mb-4 opacity-0 translate-y-8" data-anime="env-title"></p>
      <h1 class="text-4xl md:text-5xl font-bold mb-4 opacity-0 translate-y-8" data-anime="title">PKC Landing Page</h1>
      <p class="text-xl md:text-2xl mb-12 opacity-0 translate-y-8" data-anime="subtitle">Static-first. Modular by design. Local‚Äëfirst ready.</p>
      <div class="flex flex-wrap gap-4 justify-center mb-16 opacity-0 translate-y-8" data-anime="buttons">
        <a href="pkc-docs-index.html" class="px-6 py-3 bg-white text-pkc-primary rounded-full border border-white/40 hover:bg-white/90 transition-colors font-medium">Browse Documentation</a>
        <a href="tic-tac-toe.html" class="px-6 py-3 rounded-full border border-white/40 text-white hover:bg-white/10 transition-colors font-medium">üéÆ Tic-Tac-Toe P2P</a>
        <a href="js/modules/p2p-serverless/example.html" class="px-6 py-3 rounded-full border border-white/40 text-white hover:bg-white/10 transition-colors font-medium">üîó P2P Demo</a>
        <a href="js/modules/webrtc-dashboard/index.html" class="px-6 py-3 rounded-full border border-white/40 text-white hover:bg-white/10 transition-colors font-medium">üåê WebRTC Dashboard</a>
        <a href="pkc-viewer.html?doc=LaTeX-Test.md" class="px-6 py-3 rounded-full border border-white/40 text-white hover:bg-white/10 transition-colors font-medium">LaTeX Test</a>
        <a href="https://github.com/xlp0/LandingPage" target="_blank" rel="noopener" class="px-6 py-3 rounded-full border border-white/40 text-white hover:bg-white/10 transition-colors font-medium">GitHub</a>
        <a href="/js/modules/video-meeting/index.html" class="px-6 py-3 rounded-full border border-white/40 text-white hover:bg-white/10 transition-colors font-medium">üé• Video Meeting P2P</a>
      </div>
    </div>
    
    <!-- P2P Status Panel -->
    <div id="p2p-panel" class="fixed left-4 bottom-4 w-72 max-h-[40vh] flex flex-col bg-black/25 border border-white/25 rounded-xl text-white backdrop-blur-md overflow-hidden z-50" aria-live="polite">
      <div class="px-3 py-2 border-b border-white/15 font-semibold flex justify-between items-center gap-2">
        <span>P2P</span>
        <div class="flex gap-2 text-xs">
          <span>Clients: <span id="client-count">0</span></span>
          <span>Peers: <span id="peer-count">0</span></span>
        </div>
      </div>
      <div class="px-3 py-2 overflow-auto text-sm">
        <div id="p2p-status" class="opacity-90">idle</div>
        <div id="p2p-messages" class="mt-2 max-h-52 overflow-y-auto whitespace-pre-wrap break-words break-all font-mono text-xs leading-snug space-y-1"></div>
      </div>
    </div>
    
    <!-- WebSocket Status Badge -->
    <div id="ws-status" class="fixed right-4 bottom-4 px-3 py-1.5 rounded-full text-xs font-semibold tracking-wide bg-white/15 border border-white/30 backdrop-blur-md inline-flex items-center gap-1.5 text-white z-50" aria-live="polite">
      <span class="w-2 h-2 rounded-full bg-gray-400" id="ws-dot"></span>
      <span>WS: idle</span>
    </div>
    
    <!-- Runtime environment watcher -->
    <script>
      async function updateEnvTitle() {
        try {
          // Try to fetch from API endpoint (now served from same port)
          const response = await fetch('/api/env', { cache: 'no-cache' });
          if (response.ok) {
            const env = await response.json();
            if (env.PKC_Title_Text) {
              const titleEl = document.getElementById('pkc-title-text');
              if (titleEl && titleEl.textContent !== env.PKC_Title_Text) {
                titleEl.textContent = env.PKC_Title_Text;
                console.log('[PKC] Title updated to:', env.PKC_Title_Text);
              }
            }
          }
        } catch (err) {
          // Fallback: try to load .env file directly (works in static server)
          try {
            const response = await fetch('.env', { cache: 'no-cache' });
            if (response.ok) {
              const data = await response.text();
              const lines = data.split('\n');
              for (const line of lines) {
                if (line.startsWith('PKC_Title_Text=')) {
                  const value = line.split('=')[1].trim();
                  const titleEl = document.getElementById('pkc-title-text');
                  if (titleEl && titleEl.textContent !== value) {
                    titleEl.textContent = value;
                    console.log('[PKC] Title updated to:', value);
                  }
                  break;
                }
              }
            }
          } catch (fallbackErr) {
            console.error('[PKC] Failed to load env from both sources:', err, fallbackErr);
          }
        }
      }

      // Initial load
      updateEnvTitle();

      // Poll for env changes every 2 seconds
      setInterval(updateEnvTitle, 2000);
    </script>
    
    <script type="module">
      import { PKC } from './js/pkc-core.js';
      
      // Anime.js Page Animations
      document.addEventListener('DOMContentLoaded', () => {
        // Page entrance animations
        const tl = anime.timeline({
          easing: 'easeOutExpo',
          duration: 800
        });
        
        tl.add({
          targets: '[data-anime="env-title"]',
          opacity: [0, 1],
          translateY: [32, 0],
          duration: 1000
        })
        .add({
          targets: '[data-anime="title"]',
          opacity: [0, 1],
          translateY: [32, 0],
          duration: 1000
        })
        .add({
          targets: '[data-anime="subtitle"]',
          opacity: [0, 1],
          translateY: [24, 0],
          duration: 800
        }, '-=600')
        .add({
          targets: '[data-anime="buttons"]',
          opacity: [0, 1],
          translateY: [16, 0],
          duration: 600
        }, '-=400');
        
        // Button hover animations
        const buttons = document.querySelectorAll('[data-anime="buttons"] a');
        buttons.forEach(button => {
          button.addEventListener('mouseenter', () => {
            anime({
              targets: button,
              scale: 1.05,
              duration: 200,
              easing: 'easeOutQuad'
            });
          });
          
          button.addEventListener('mouseleave', () => {
            anime({
              targets: button,
              scale: 1,
              duration: 200,
              easing: 'easeOutQuad'
            });
          });
        });
        
        // Status panel slide-in animation
        const p2pPanel = document.getElementById('p2p-panel');
        const wsStatus = document.getElementById('ws-status');
        
        anime({
          targets: p2pPanel,
          translateX: [-300, 0],
          opacity: [0, 1],
          duration: 800,
          delay: 1000,
          easing: 'easeOutExpo'
        });
        
        anime({
          targets: wsStatus,
          translateX: [300, 0],
          opacity: [0, 1],
          duration: 800,
          delay: 1200,
          easing: 'easeOutExpo'
        });
        
        // Status dot pulse animation
        const wsDot = document.getElementById('ws-dot');
        anime({
          targets: wsDot,
          scale: [1, 1.2, 1],
          duration: 2000,
          loop: true,
          easing: 'easeInOutQuad',
          delay: 2000
        });
        
        // Add floating background elements
        createFloatingElements();
      });
      
      // Create floating background elements
      function createFloatingElements() {
        const body = document.body;
        const colors = ['#667eea', '#764ba2', '#ffd700'];
        
        for (let i = 0; i < 8; i++) {
          const element = document.createElement('div');
          element.className = 'fixed pointer-events-none rounded-full opacity-10';
          element.style.width = Math.random() * 100 + 20 + 'px';
          element.style.height = element.style.width;
          element.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          element.style.left = Math.random() * 100 + '%';
          element.style.top = Math.random() * 100 + '%';
          
          body.appendChild(element);
          
          // Animate floating elements
          anime({
            targets: element,
            translateX: () => anime.random(-50, 50),
            translateY: () => anime.random(-50, 50),
            scale: [0.8, 1.2, 0.8],
            duration: 4000 + Math.random() * 4000,
            loop: true,
            easing: 'easeInOutQuad',
            delay: Math.random() * 2000
          });
        }
      }
      
      PKC.load('/modules.json');
    </script>
    
    <!-- Authentication Integration -->
    <script>
      // Initialize OAuth handler and storage
      const storage = new LocalStorageManager({
        appName: 'PKC',
        version: '1.0.0'
      });
      
      const oauth = new OAuth2Handler({
        clientId: '348373619962871815',
        domain: 'vpn.pkc.pub',
        redirectUri: window.location.origin + '/auth-callback-enhanced.html',
        scopes: ['openid', 'profile', 'email'],
        debug: true
      });
      
      // Redux store for auth state
      const { configureStore, createSlice } = window.RTK;
      
      const authSlice = createSlice({
        name: 'auth',
        initialState: {
          isAuthenticated: false,
          user: null,
          token: null,
          refreshToken: null,
          loading: false,
          error: null,
          loginMethod: null
        },
        reducers: {
          setAuth: (state, action) => {
            state.isAuthenticated = action.payload.isAuthenticated;
            state.user = action.payload.user;
            state.token = action.payload.token;
            state.refreshToken = action.payload.refreshToken;
            state.loginMethod = action.payload.loginMethod;
          },
          clearAuth: (state) => {
            state.isAuthenticated = false;
            state.user = null;
            state.token = null;
            state.refreshToken = null;
            state.loginMethod = null;
          }
        }
      });
      
      const store = configureStore({
        reducer: {
          auth: authSlice.reducer
        }
      });
      
      // App object for global access
      window.app = {
        async login() {
          console.log('[App] Initiating login flow...');
          await oauth.redirectToLogin();
        },
        
        async logout() {
          console.log('[App] Logging out...');
          
          // Clear Redux state
          store.dispatch(authSlice.actions.clearAuth());
          
          // Clear local storage
          localStorage.removeItem('auth_token');
          localStorage.removeItem('refresh_token');
          localStorage.removeItem('auth_code');
          localStorage.removeItem('pkce_code_verifier');
          storage.clearUser();
          
          // Update UI
          updateAuthUI();
          
          // Redirect to Zitadel logout
          const logoutUrl = `https://vpn.pkc.pub/oidc/v1/end_session?post_logout_redirect_uri=${encodeURIComponent(window.location.origin)}`;
          window.location.href = logoutUrl;
        },
        
        getUser() {
          return store.getState().auth.user;
        },
        
        isAuthenticated() {
          return store.getState().auth.isAuthenticated;
        }
      };
      
      // Update auth UI
      function updateAuthUI() {
        const authButton = document.getElementById('auth-button');
        const authUserInfo = document.getElementById('auth-user-info');
        const authUserName = document.getElementById('auth-user-name');
        
        const state = store.getState().auth;
        
        if (state.isAuthenticated && state.user) {
          // Show user info
          authUserName.textContent = state.user.name || state.user.email;
          authUserInfo.classList.remove('hidden');
          
          // Change button to logout
          authButton.textContent = 'Logout';
          authButton.onclick = () => app.logout();
          authButton.classList.remove('bg-white', 'text-pkc-primary');
          authButton.classList.add('bg-red-500', 'text-white');
          
          console.log('[App] User authenticated:', state.user);
        } else {
          // Hide user info
          authUserInfo.classList.add('hidden');
          
          // Change button to login
          authButton.textContent = 'Login';
          authButton.onclick = () => app.login();
          authButton.classList.remove('bg-red-500', 'text-white');
          authButton.classList.add('bg-white', 'text-pkc-primary');
        }
      }
      
      // Check for existing auth on page load
      async function checkExistingAuth() {
        console.log('[App] Checking for existing auth...');
        
        const token = localStorage.getItem('auth_token');
        const userStr = localStorage.getItem('user');
        
        if (token && userStr) {
          try {
            const user = JSON.parse(userStr);
            
            // Update Redux store
            store.dispatch(authSlice.actions.setAuth({
              isAuthenticated: true,
              user: user,
              token: token,
              refreshToken: localStorage.getItem('refresh_token'),
              loginMethod: 'zitadel'
            }));
            
            console.log('[App] Restored auth session:', user);
          } catch (error) {
            console.error('[App] Failed to restore auth:', error);
          }
        }
        
        // Update UI
        updateAuthUI();
        
        // Check if we need to exchange code
        const code = localStorage.getItem('auth_code');
        const codeVerifier = localStorage.getItem('pkce_code_verifier');
        
        if (code && codeVerifier) {
          await exchangeCodeForToken();
        }
      }
      
      // Exchange authorization code for token
      async function exchangeCodeForToken() {
        const code = localStorage.getItem('auth_code');
        const codeVerifier = localStorage.getItem('pkce_code_verifier');
        
        if (!code) {
          console.log('[App] No code to exchange');
          return;
        }
        
        try {
          console.log('[App] Exchanging authorization code for token...');
          
          const response = await fetch('/api/auth/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              code: code,
              codeVerifier: codeVerifier,
              redirectUri: window.location.origin + '/auth-callback-enhanced.html'
            })
          });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.details || `Backend returned ${response.status}`);
          }
          
          const data = await response.json();
          
          console.log('[App] Real user data received:', data.user);
          
          // Update Redux store
          store.dispatch(authSlice.actions.setAuth({
            isAuthenticated: true,
            user: data.user,
            token: data.token,
            refreshToken: data.refreshToken,
            loginMethod: 'zitadel'
          }));
          
          // Save to localStorage
          localStorage.setItem('auth_token', data.token);
          localStorage.setItem('refresh_token', data.refreshToken);
          localStorage.setItem('user', JSON.stringify(data.user));
          storage.setUser(data.user);
          
          // Clear auth code
          localStorage.removeItem('auth_code');
          
          // Update UI
          updateAuthUI();
          
          console.log('[App] Authentication complete!');
        } catch (error) {
          console.error('[App] Token exchange failed:', error);
        }
      }
      
      // Initialize auth on page load
      document.addEventListener('DOMContentLoaded', () => {
        checkExistingAuth();
      });
      
      // Subscribe to Redux store changes
      store.subscribe(() => {
        updateAuthUI();
      });
    </script>
</body>
</html>
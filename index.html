<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKC Account Management - CLM Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè¢</text></svg>">
    
    <!-- Import Map for ES Modules -->
    <script type="importmap">
    {
      "imports": {
        "redux": "https://cdn.jsdelivr.net/npm/redux@4.2.1/+esm",
        "redux-thunk": "https://cdn.jsdelivr.net/npm/redux-thunk@2.4.2/+esm",
        "immer": "https://cdn.jsdelivr.net/npm/immer@9.0.21/+esm",
        "reselect": "https://cdn.jsdelivr.net/npm/reselect@4.1.8/+esm",
        "@reduxjs/toolkit": "https://cdn.jsdelivr.net/npm/@reduxjs/toolkit@1.9.7/+esm"
      }
    }
    </script>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        color: white;
        overflow: hidden;
      }

      .dashboard-container {
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* Sidebar for component selection */
      .component-sidebar {
        width: 280px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .sidebar-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .component-count {
        font-size: 12px;
        opacity: 0.7;
      }

      .component-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      /* Category styles */
      .component-category {
        margin-bottom: 16px;
      }

      .category-header {
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        user-select: none;
      }

      .category-header:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .category-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 14px;
      }

      .category-icon {
        font-size: 16px;
      }

      .category-count {
        font-size: 11px;
        opacity: 0.7;
        background: rgba(255, 255, 255, 0.1);
        padding: 2px 8px;
        border-radius: 12px;
      }

      .category-chevron {
        font-size: 12px;
        transition: transform 0.2s;
      }

      .category-header.expanded .category-chevron {
        transform: rotate(90deg);
      }

      .category-items {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        padding-left: 12px;
      }

      .category-items.expanded {
        max-height: 2000px;
        transition: max-height 0.5s ease-in;
      }

      .component-item {
        padding: 10px 16px;
        margin: 6px 0;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-left: 3px solid transparent;
      }

      .component-item:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateX(4px);
      }

      .component-item.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: rgba(255, 255, 255, 0.3);
        border-left-color: #fff;
        transform: translateX(4px);
      }

      .component-item-name {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .component-item-hash {
        font-size: 11px;
        opacity: 0.6;
        font-family: monospace;
      }

      /* Main content area */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .components-grid {
        display: none; /* Hide old grid view */
      }

      .dashboard-header {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .dashboard-title {
        font-size: 24px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .clm-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 1px;
      }

      /* Single component viewer */
      .component-viewer {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow: hidden;
      }

      .component-frame {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        position: relative;
        flex: 1;
        display: none; /* Hidden by default */
      }

      .component-frame.active {
        display: flex;
        flex-direction: column;
      }

      .component-label {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #4caf50;
        animation: pulse 2s infinite;
      }

      .status-dot.error {
        background: #f44336;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .components-grid::-webkit-scrollbar {
        width: 8px;
      }

      .components-grid::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
      }

      .components-grid::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }

      .components-grid::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s;
      }

      .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .loader {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .loading-text {
        margin-top: 20px;
        font-size: 16px;
        color: rgba(255, 255, 255, 0.8);
      }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loader"></div>
      <div class="loading-text">Loading CLM Components...</div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
      <!-- Sidebar -->
      <div class="component-sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">
            <span>üì¶</span>
            <span>Components</span>
          </div>
          <div class="component-count">
            <span id="componentCount">0</span> CLM Modules
          </div>
        </div>
        <div class="component-list" id="componentList">
          <!-- Component items will be dynamically inserted here -->
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header -->
        <div class="dashboard-header">
          <div class="dashboard-title">
            <span>üè¢</span>
            <span>CLM Dashboard</span>
            <span class="clm-badge">SINGLE VIEW</span>
          </div>
          <div style="display: flex; align-items: center; gap: 20px;">
            <button id="loginBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: transform 0.2s;">
              üîê Login
            </button>
          </div>
        </div>

        <!-- Component Viewer -->
        <div class="component-viewer" id="componentViewer">
          <!-- Active component will be displayed here -->
        </div>
      </div>
    </div>

    <!-- OAuth Handler -->
    <script src="./js/oauth-handler.js"></script>
    <script src="./js/local-storage-manager.js"></script>

    <!-- Redux Store -->
    <script type="module">
      import store from './js/redux/store.js';
      import { 
        fetchCLMRegistry, 
        loadCLMComponent,
        componentLoaded,
        setActiveComponent,
        selectCLMState
      } from './js/redux/slices/clm-slice.js';
      import { 
        loginWithZitadel, 
        logoutUser,
        selectUser,
        selectIsAuthenticated 
      } from './js/redux/slices/auth-slice.js';

      console.log('[Dashboard] Initializing CLM Account Management Dashboard with Redux...');

      // Make store globally available
      window.reduxStore = store;

      // Fetch OAuth configuration from environment
      let oauth;
      async function initializeOAuth() {
        try {
          const envResponse = await fetch('/api/env');
          const envData = await envResponse.json();
          
          // Initialize OAuth handler with environment config
          oauth = new window.OAuth2Handler({
            domain: envData.ZITADEL_DOMAIN || 'vpn.pkc.pub',
            clientId: envData.ZITADEL_CLIENT_ID || '348213051452882951',
            redirectUri: envData.REDIRECT_URI || (window.location.origin + '/auth-callback-enhanced.html'),
            scopes: ['openid', 'profile', 'email'],
            debug: true
          });
          
          console.log('[Dashboard] OAuth initialized with:', {
            domain: oauth.domain,
            clientId: oauth.clientId,
            redirectUri: oauth.redirectUri
          });
          
          return oauth;
        } catch (error) {
          console.error('[Dashboard] Failed to fetch OAuth config, using defaults:', error);
          // Fallback to defaults
          oauth = new window.OAuth2Handler({
            domain: 'vpn.pkc.pub',
            clientId: '348213051452882951',
            redirectUri: window.location.origin + '/auth-callback-enhanced.html',
            scopes: ['openid', 'profile', 'email'],
            debug: true
          });
          return oauth;
        }
      }

      // Check if user is already logged in from Redux
      function checkAuthStatus() {
        const state = store.getState();
        const isAuthenticated = selectIsAuthenticated(state);
        const user = selectUser(state);
        const loginBtn = document.getElementById('loginBtn');
        
        if (isAuthenticated && user) {
          loginBtn.innerHTML = `üë§ ${user.name || user.email || 'User'}`;
          loginBtn.style.background = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';
          // Reduced logging - only log on initial load
        } else {
          loginBtn.innerHTML = 'üîê Login';
          loginBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
      }

      // Subscribe to auth state changes
      store.subscribe(() => {
        checkAuthStatus();
      });

      // Login button handler
      document.getElementById('loginBtn').addEventListener('click', async () => {
        const state = store.getState();
        const isAuthenticated = selectIsAuthenticated(state);
        
        // If already logged in, logout via Redux
        if (isAuthenticated) {
          const logout = confirm('You are already logged in. Do you want to logout?');
          if (logout) {
            await store.dispatch(logoutUser());
            console.log('[Dashboard] Logged out via Redux');
          }
          return;
        }
        
        console.log('[Dashboard] Login button clicked');
        try {
          // Ensure OAuth is initialized
          if (!oauth) {
            console.log('[Dashboard] OAuth not initialized, initializing now...');
            await initializeOAuth();
          }
          
          // Generate PKCE challenge
          const { codeVerifier, codeChallenge } = await oauth.generatePKCE();
          
          // Store code verifier for callback
          localStorage.setItem('pkce_code_verifier', codeVerifier);
          
          // Build authorization URL
          const authUrl = `https://${oauth.domain}/oauth/v2/authorize?` + new URLSearchParams({
            client_id: oauth.clientId,
            redirect_uri: oauth.redirectUri,
            response_type: 'code',
            scope: oauth.scopes.join(' '),
            code_challenge: codeChallenge,
            code_challenge_method: 'S256',
            state: btoa(JSON.stringify({ timestamp: Date.now() }))
          });
          
          console.log('[Dashboard] Redirecting to OAuth login...');
          window.location.href = authUrl;
        } catch (error) {
          console.error('[Dashboard] Login error:', error);
          alert('Login failed: ' + error.message);
        }
      });

      // Check auth status on load
      checkAuthStatus();

      // Create component frame dynamically
      function createComponentFrame(component) {
        const iframeId = `iframe-${component.hash}`;
        const statusId = `status-${component.hash}`;
        
        // Determine display name
        const displayName = component.name || component.hash;
        const reduxSlice = component.concrete?.redux_slice || component.redux_slice;
        const label = reduxSlice ? `${displayName} [Redux: ${reduxSlice}]` : displayName;
        const isExpectedFailure = component.balanced?.expected_failure;
        
        const frame = document.createElement('div');
        frame.className = 'component-frame';
        frame.innerHTML = `
          <div class="component-label">
            <span class="status-dot ${isExpectedFailure ? 'error' : ''}" id="${statusId}"></span>
            <span>${label}</span>
          </div>
          <iframe id="${iframeId}" sandbox="${component.concrete?.sandbox || 'allow-scripts'}"></iframe>
        `;
        
        return { frame, iframeId, statusId };
      }

      // Switch to a component
      function switchToComponent(componentHash) {
        // Hide all component frames
        document.querySelectorAll('.component-frame').forEach(frame => {
          frame.classList.remove('active');
        });
        
        // Show selected component frame
        const selectedFrame = document.getElementById(`frame-${componentHash}`);
        if (selectedFrame) {
          selectedFrame.classList.add('active');
        }
        
        // Update sidebar selection
        document.querySelectorAll('.component-item').forEach(item => {
          item.classList.remove('active');
        });
        const selectedItem = document.getElementById(`item-${componentHash}`);
        if (selectedItem) {
          selectedItem.classList.add('active');
        }
        
        // Update Redux state
        store.dispatch(setActiveComponent(componentHash));
        
        console.log('[Dashboard] Switched to component:', componentHash);
      }

      // Categorize components automatically
      function categorizeComponents(components) {
        const internal = [];
        const external = [];
        
        components.forEach(comp => {
          const impl = comp.concrete?.implementation || '';
          // External if starts with http:// or https://
          if (impl.startsWith('http://') || impl.startsWith('https://')) {
            external.push(comp);
          } else {
            internal.push(comp);
          }
        });
        
        return { internal, external };
      }

      // Create category section
      function createCategorySection(categoryName, icon, components, isExpanded = true) {
        const category = document.createElement('div');
        category.className = 'component-category';
        
        const header = document.createElement('div');
        header.className = `category-header ${isExpanded ? 'expanded' : ''}`;
        header.innerHTML = `
          <div class="category-title">
            <span class="category-icon">${icon}</span>
            <span>${categoryName}</span>
            <span class="category-count">${components.length}</span>
          </div>
          <span class="category-chevron">‚ñ∂</span>
        `;
        
        const itemsContainer = document.createElement('div');
        itemsContainer.className = `category-items ${isExpanded ? 'expanded' : ''}`;
        
        // Toggle category on click
        header.onclick = () => {
          const isCurrentlyExpanded = header.classList.contains('expanded');
          header.classList.toggle('expanded');
          itemsContainer.classList.toggle('expanded');
          
          console.log(`[Dashboard] ${categoryName} ${isCurrentlyExpanded ? 'collapsed' : 'expanded'}`);
        };
        
        category.appendChild(header);
        category.appendChild(itemsContainer);
        
        return { category, itemsContainer };
      }

      // Load all components using Redux
      async function loadDashboard() {
        try {
          // Fetch registry via Redux thunk
          const registryAction = await store.dispatch(fetchCLMRegistry());
          
          if (fetchCLMRegistry.fulfilled.match(registryAction)) {
            const registry = registryAction.payload;
            console.log('[Dashboard] Registry loaded via Redux:', registry);

            const componentList = document.getElementById('componentList');
            const componentViewer = document.getElementById('componentViewer');
            const componentCount = document.getElementById('componentCount');
            
            // Update component count
            componentCount.textContent = registry.components.length;

            // Categorize components
            const { internal, external } = categorizeComponents(registry.components);
            console.log('[Dashboard] Categorized:', { internal: internal.length, external: external.length });

            // Clear component list
            componentList.innerHTML = '';

            // Create Internal Components category
            if (internal.length > 0) {
              const { category: internalCategory, itemsContainer: internalItems } = 
                createCategorySection('Internal Components', 'üè†', internal, true);
              componentList.appendChild(internalCategory);
              
              // Add internal component items
              internal.forEach(componentConfig => {
                const item = document.createElement('div');
                item.className = 'component-item';
                item.id = `item-${componentConfig.hash}`;
                item.innerHTML = `
                  <div class="component-item-name">${componentConfig.name}</div>
                  <div class="component-item-hash">${componentConfig.hash}</div>
                `;
                item.onclick = () => switchToComponent(componentConfig.hash);
                internalItems.appendChild(item);
              });
            }

            // Create External Components category
            if (external.length > 0) {
              const { category: externalCategory, itemsContainer: externalItems } = 
                createCategorySection('External Components', 'üåê', external, true);
              componentList.appendChild(externalCategory);
              
              // Add external component items
              external.forEach(componentConfig => {
                const item = document.createElement('div');
                item.className = 'component-item';
                item.id = `item-${componentConfig.hash}`;
                item.innerHTML = `
                  <div class="component-item-name">${componentConfig.name}</div>
                  <div class="component-item-hash">${componentConfig.hash}</div>
                `;
                item.onclick = () => switchToComponent(componentConfig.hash);
                externalItems.appendChild(item);
              });
            }

            // Load each component from registry (create iframes)
            for (let i = 0; i < registry.components.length; i++) {
              const componentConfig = registry.components[i];
              
              // Create component frame
              const { frame, iframeId, statusId } = createComponentFrame(componentConfig);
              frame.id = `frame-${componentConfig.hash}`;
              componentViewer.appendChild(frame);

              // Dispatch load action
              const loadAction = await store.dispatch(
                loadCLMComponent({ 
                  componentId: componentConfig.hash, 
                  iframeId: iframeId 
                })
              );

              if (loadCLMComponent.fulfilled.match(loadAction)) {
                console.log('[Dashboard] Loaded component via Redux:', componentConfig.hash);
                
                // Set iframe src
                const iframe = document.getElementById(iframeId);
                if (iframe) {
                  iframe.src = componentConfig.concrete?.implementation || componentConfig.url;
                  
                  // Dispatch componentLoaded when iframe loads
                  iframe.onload = () => {
                    store.dispatch(componentLoaded({
                      componentId: componentConfig.hash,
                      iframeId: iframeId,
                      url: componentConfig.url
                    }));
                  };
                }
              }
            }

            // Show first component by default
            if (registry.components.length > 0) {
              switchToComponent(registry.components[0].hash);
            }

            // Hide loading overlay after all components are loaded
            setTimeout(() => {
              const loadingOverlay = document.querySelector('.loading-overlay');
              if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
              }
              console.log('[Dashboard] All components loaded, hiding overlay');
            }, 1000);
          }

        } catch (error) {
          console.error('[Dashboard] Failed to load:', error);
          const loadingOverlay = document.querySelector('.loading-overlay');
          if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
          }
          alert('Failed to load components: ' + error.message);
        }
      }

      // Monitor heartbeats and update UI
      window.addEventListener('message', (event) => {
        if (event.data.type === 'clm_heartbeat') {
          const statusDot = document.getElementById(`status-${event.data.componentId}`);
          if (statusDot) {
            statusDot.style.background = '#4caf50';
          }
        }

        // Handle Redux state requests from components
        if (event.data.type === 'request_redux_state') {
          const state = store.getState();
          const iframe = document.getElementById(`iframe-${event.data.componentId}`);
          if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage({
              type: 'redux_state_update',
              state: state,
              timestamp: Date.now()
            }, '*');
          }
        }
      });

      // Subscribe to Redux state changes for debugging (reduced verbosity)
      let lastComponentCount = 0;
      store.subscribe(() => {
        const state = store.getState();
        const clmState = selectCLMState(state);
        const currentCount = Object.keys(clmState.components).length;
        
        // Only log when component count changes
        if (currentCount !== lastComponentCount) {
          console.log('[Dashboard] Redux State:', {
            loadedComponents: currentCount,
            totalEvents: clmState.events.length,
            metrics: clmState.metrics
          });
          lastComponentCount = currentCount;
        }
      });

      // Initialize OAuth and start loading
      (async () => {
        await initializeOAuth();
        loadDashboard();
      })();

      console.log('[Dashboard] CLM Dashboard with Redux initialized');
    </script>

    <!-- Grafana Faro Web SDK for Real User Monitoring -->
    <script src="https://unpkg.com/@grafana/faro-web-sdk@^1.3.0/dist/bundle/faro-web-sdk.iife.js"></script>
    <script>
      // Initialize Grafana Faro
      (function() {
        try {
          const faro = window.GrafanaFaroWebSdk.initializeFaro({
            url: 'https://faro-collector-prod-ap-southeast-2.grafana.net/collect/2a49694fa859f4189869a5157f39c44d',
            app: {
              name: 'THK Mesh Landing Page',
              version: '1.0.0',
              environment: 'production'
            },
            instrumentations: [
              // Automatic instrumentation for web vitals, errors, etc.
              ...window.GrafanaFaroWebSdk.getWebInstrumentations({
                captureConsole: true,
                captureConsoleDisabledLevels: []
              })
            ]
          });

          // Make Faro globally available
          window.faro = faro;

          console.log('[Faro] ‚úì Initialized successfully');
          console.log('[Faro] Tracking: Web Vitals, Errors, User Interactions');

          // Track initial page load
          faro.api.pushEvent('page_loaded', {
            page: 'dashboard',
            timestamp: Date.now(),
            user_agent: navigator.userAgent,
            screen_width: window.innerWidth,
            screen_height: window.innerHeight
          });

        } catch (error) {
          console.error('[Faro] Failed to initialize:', error);
        }
      })();

      // Add Faro middleware to Redux store
      const faroMiddleware = store => next => action => {
        const result = next(action);
        
        if (window.faro) {
          // Track component navigation
          if (action.type === 'clm/setActiveComponent') {
            const state = store.getState();
            const clmState = selectCLMState(state);
            const component = clmState.registry?.components?.find(
              c => c.hash === action.payload
            );
            
            if (component) {
              window.faro.api.pushEvent('clm_component_visit', {
                component_hash: component.hash,
                component_name: component.name,
                timestamp: Date.now(),
                previous_component: clmState.activeComponent || 'none'
              });
              
              console.log('[Faro] Tracked component visit:', component.name);
            }
          }
          
          // Track component load success
          if (action.type === 'clm/componentLoaded') {
            const { hash, loadTime } = action.payload || {};
            if (hash) {
              window.faro.api.pushEvent('clm_component_loaded', {
                component_hash: hash,
                load_time_ms: loadTime || 0,
                timestamp: Date.now()
              });
              
              console.log('[Faro] Tracked component load:', hash, loadTime + 'ms');
            }
          }
          
          // Track component errors
          if (action.type === 'clm/componentFailed') {
            const { hash, error } = action.payload || {};
            if (hash) {
              window.faro.api.pushError(
                new Error(`Component ${hash} failed: ${error}`),
                {
                  context: {
                    component_hash: hash,
                    error_type: 'component_load_failure',
                    error_message: error
                  }
                }
              );
              
              console.error('[Faro] Tracked component error:', hash, error);
            }
          }
        }
        
        return result;
      };

      // Recreate store with Faro middleware
      const storeWithFaro = configureStore({
        reducer: {
          clm: clmReducer
        },
        middleware: (getDefaultMiddleware) =>
          getDefaultMiddleware().concat(faroMiddleware)
      });

      // Replace global store reference
      window.store = storeWithFaro;

      console.log('[Faro] Middleware added to Redux store');
    </script>
</body>
</html>
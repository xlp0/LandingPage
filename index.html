<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCard Manager</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Content-addressable card management system with local-first storage">
  <meta name="theme-color" content="#007acc">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MCard Manager">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/public/manifest.json">
  <link rel="icon" type="image/svg+xml" href="/public/icon.svg">
  <link rel="apple-touch-icon" href="/public/icon.svg">
  
  <!-- Performance Optimization: Resource Hints -->
  <!-- Preconnect to CDN origins for faster loading -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  
  <!-- Preload critical CSS -->
  <link rel="preload" href="/css/mcard-manager.css" as="style">
  
  <!-- Preload critical JavaScript -->
  <link rel="preload" href="/js/mcard-manager-new.js" as="script" crossorigin>
  
  <!-- Define process.env for browser compatibility -->
  <script>
    // Redux Toolkit expects process.env.NODE_ENV
    window.process = {
      env: {
        NODE_ENV: 'production'
      }
    };
  </script>
  
  <!-- Auto-generate Import Map based on current URL -->
  <script>
    // Must run synchronously before any module imports
    (function() {
      const { protocol, hostname, port } = window.location;
      let baseUrl = `${protocol}//${hostname}`;
      if (port && port !== '80' && port !== '443') {
        baseUrl += `:${port}`;
      }
      
      const vendorPath = `${baseUrl}/vendor`;
      
      const importMap = {
        imports: {
          'redux': `${vendorPath}/redux/redux.esm.js`,
          'redux-thunk': `${vendorPath}/redux/redux-thunk-esm.js`,
          'immer': `${vendorPath}/redux/immer-esm.js`,
          'reselect': `${vendorPath}/redux/reselect-esm.js`,
          '@reduxjs/toolkit': `${vendorPath}/redux/toolkit.esm.js`,
          'mcard-js': `${baseUrl}/js/vendor/mcard-js.bundle.js`
        }
      };
      
      const script = document.createElement('script');
      script.type = 'importmap';
      script.textContent = JSON.stringify(importMap, null, 2);
      document.currentScript.parentNode.insertBefore(script, document.currentScript.nextSibling);
      
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        console.log('üåç Auto-detected BASE_URL:', baseUrl);
        console.log('üì¶ Import Map:', importMap);
      }
    })();
  </script>
  
  <!-- Lucide Icons - Self-Hosted -->
  <script src="/vendor/lucide/lucide.min.js"></script>
  <!-- MCard Manager CSS -->
  <link rel="stylesheet" href="/css/mcard-manager.css">
  <!-- Content Renderers CSS -->
  <link rel="stylesheet" href="/css/content-renderers.css">
</head>
<body>
  <!-- Offline Indicator -->
  <div id="offline-indicator" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
    color: white;
    padding: 12px 20px;
    text-align: center;
    z-index: 10001;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    animation: slideDown 0.3s ease-out;
  ">
    <i data-lucide="wifi-off" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;"></i>
    You're offline - Working from cache
  </div>

  <div class="container">
    <div class="header">
      <div class="header-left">
        <button class="header-btn" onclick="window.location.href='/'" style="margin-right: 12px;" title="Back to Landing Page">
          <i data-lucide="home" style="width: 16px; height: 16px;"></i>
          Home
        </button>
        <i data-lucide="package" style="width: 20px; height: 20px;"></i>
        <h1>MCard Manager</h1>
      </div>
      <div class="header-right">
        <button class="header-btn" onclick="document.getElementById('fileInput').click()">
          <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
          Upload
        </button>
        <button class="header-btn" onclick="createTextCard()">
          <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
          New Text
        </button>
        <button class="header-btn" onclick="toggleChat()">
          <i data-lucide="message-square" style="width: 16px; height: 16px;"></i>
          Chat
        </button>
      </div>
      <input type="file" id="fileInput" multiple style="display: none;">
    </div>

    <!-- Full-Width Calendar View -->
    <div class="calendar-view" id="calendarView" style="display: none;">
      <div class="calendar-header">
        <button class="header-btn" onclick="hideCalendar()">
          <i data-lucide="x" style="width: 16px; height: 16px;"></i>
          Close Calendar
        </button>
        <h2 style="margin: 0; flex: 1; text-align: center;">
          <i data-lucide="calendar" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;"></i>
          Public Calendar
        </h2>
        <div style="width: 120px;"></div> <!-- Spacer for centering -->
      </div>
      <div class="calendar-container" id="calendarContainer">
        <iframe 
          id="calendarFrame"
          src="https://calendar.google.com/calendar/embed?src=83eaf0af7e929d74dc166a19beb26b471f351697c5b0ba8d92e3a9a30540ca8d%40group.calendar.google.com&ctz=Asia%2FMakassar"
          style="border: 0; width: 100%; height: 100%;"
          frameborder="0"
          scrolling="no">
        </iframe>
      </div>
    </div>

    <div class="main-content">
      <!-- Left Sidebar: File Types -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <h3>Card Types</h3>
            <button class="collapse-btn" id="collapseBtn" onclick="toggleSidebar()" title="Collapse sidebar">
              <i data-lucide="chevrons-left" style="width: 16px; height: 16px;"></i>
            </button>
          </div>
        </div>
        <div class="type-list" id="typeList">
          <!-- Card types will be populated here -->
        </div>
      </div>

      <!-- Middle Column: MCard List -->
      <div class="middle-column">
        <div class="mobile-back-btn" onclick="navigateBack()">
          <i data-lucide="chevron-left" style="width: 16px; height: 16px;"></i>
          Back to Types
        </div>
        <div class="column-header">
          <h3 id="columnTitle">All MCards</h3>
          <div style="position: relative; margin-top: 8px;">
            <i data-lucide="search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: #999;"></i>
            <input type="text" class="search-box" placeholder="Search files or @handle..." id="searchBox" style="width: 100%; padding-left: 40px; padding-right: 40px;">
            <button class="filter-toggle-btn" id="filterToggleBtn" onclick="toggleSearchFilters()" title="Search filters">
              <i data-lucide="filter" style="width: 16px; height: 16px;"></i>
            </button>
          </div>
          <!-- Search Filters Dropdown -->
          <div class="search-filters" id="searchFilters" style="display: none;">
            <div class="filter-section">
              <label class="filter-label">Filter by:</label>
              <div class="filter-options">
                <label class="filter-option">
                  <input type="checkbox" id="filterWithHandles" onchange="applySearchFilters()">
                  <span>With Handles Only</span>
                </label>
                <label class="filter-option">
                  <input type="checkbox" id="filterCapital" onchange="applySearchFilters()">
                  <span>Capital Letters Only</span>
                </label>
                <label class="filter-option">
                  <input type="checkbox" id="filterMarkdown" onchange="applySearchFilters()">
                  <span>Markdown Files</span>
                </label>
                <label class="filter-option">
                  <input type="checkbox" id="filterImages" onchange="applySearchFilters()">
                  <span>Images Only</span>
                </label>
                <label class="filter-option">
                  <input type="checkbox" id="filterVideos" onchange="applySearchFilters()">
                  <span>Videos Only</span>
                </label>
              </div>
            </div>
            <div class="filter-section">
              <label class="filter-label">Sort by:</label>
              <div class="filter-options">
                <label class="filter-option">
                  <input type="radio" name="sortBy" value="newest" checked onchange="applySearchFilters()">
                  <span>Newest First</span>
                </label>
                <label class="filter-option">
                  <input type="radio" name="sortBy" value="oldest" onchange="applySearchFilters()">
                  <span>Oldest First</span>
                </label>
                <label class="filter-option">
                  <input type="radio" name="sortBy" value="name" onchange="applySearchFilters()">
                  <span>Name (A-Z)</span>
                </label>
              </div>
            </div>
            <div class="filter-actions">
              <button class="filter-clear-btn" onclick="clearSearchFilters()">Clear All</button>
            </div>
          </div>
        </div>
        <div class="mcard-list" id="mcardList">
          <div class="empty-state">
            <div class="empty-state-icon">
              <i data-lucide="package" style="width: 64px; height: 64px; color: #ccc;"></i>
            </div>
            <p>No MCards yet. Upload some files to get started!</p>
          </div>
        </div>
      </div>

      <!-- Right Column: Viewer -->
      <div class="viewer-column">
        <div class="mobile-back-btn" onclick="navigateBack()">
          <i data-lucide="chevron-left" style="width: 16px; height: 16px;"></i>
          Back to Cards
        </div>
        <div class="viewer-header">
          <h3 id="viewerTitle">Select an MCard</h3>
          <div class="viewer-actions" id="viewerActions" style="display: none;">
            <button class="btn" style="font-size: 12px; padding: 8px 16px; display: flex; align-items: center; gap: 6px;" onclick="downloadCurrentCard()">
              <i data-lucide="download" style="width: 16px; height: 16px;"></i>
              Download
            </button>
            <button class="btn btn-secondary" style="font-size: 12px; padding: 8px 16px; display: flex; align-items: center; gap: 6px;" onclick="deleteCurrentCard()">
              <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
              Delete
            </button>
          </div>
        </div>
        <div class="viewer-content" id="viewerContent">
          <div class="upload-section" id="uploadSection">
            <div class="upload-icon">
              <i data-lucide="upload-cloud" style="width: 64px; height: 64px; color: #667eea;"></i>
            </div>
            <h2>Upload Files</h2>
            <p>Drag & drop files here or click Upload button</p>
            <div style="margin-top: 20px;">
              <p style="font-size: 14px; color: #666; margin-bottom: 12px;"><strong>Supported Types:</strong></p>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; text-align: left; max-width: 400px; margin: 0 auto;">
                <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="file-text" style="width: 16px; height: 16px;"></i> Text</div>
                <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="image" style="width: 16px; height: 16px;"></i> Images</div>
                <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="video" style="width: 16px; height: 16px;"></i> Videos</div>
                <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="music" style="width: 16px; height: 16px;"></i> Audio</div>
                <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="file" style="width: 16px; height: 16px;"></i> Documents</div>
                <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="archive" style="width: 16px; height: 16px;"></i> Archives</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Panel -->
      <div class="chat-panel hidden" id="chatPanel">
        <div class="chat-header">
          <h3>
            <i data-lucide="message-square" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></i>
            Chat Assistant
          </h3>
          <button class="chat-close-btn" onclick="toggleChat()">
            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
          </button>
        </div>
        <div class="chat-messages" id="chatMessages">
          <div class="chat-message assistant">
            <div class="chat-message-bubble">
              üëã Hello! I'm your MCard assistant. I can help you manage your files, answer questions about content-addressable storage, or just chat!
            </div>
            <div class="chat-message-time">Just now</div>
          </div>
        </div>
        <div class="chat-input-container">
          <textarea 
            class="chat-input" 
            id="chatInput" 
            placeholder="Type your message here..."
            rows="3"
          ></textarea>
          <button class="chat-send-btn" onclick="sendChatMessage()">
            <i data-lucide="send" style="width: 14px; height: 14px;"></i>
            Send Message
          </button>
        </div>
      </div>

      <!-- Edit Panel -->
      <div class="chat-panel hidden" id="editPanel">
        <div class="chat-header">
          <h3 id="editPanelTitle">
            <i data-lucide="edit-3" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></i>
            <span id="editPanelTitleText">New Text Card</span>
          </h3>
          <button class="chat-close-btn" onclick="closeEditPanel()">
            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
          </button>
        </div>
        <div class="chat-messages" style="padding: 16px;">
          <!-- Handle Name Input -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">
              <i data-lucide="tag" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></i>
              Handle Name
            </label>
            <input 
              type="text" 
              id="editHandleName" 
              class="search-box" 
              placeholder="e.g., my-document, readme, notes"
              style="width: 100%; padding: 10px 12px;"
            />
            <p style="font-size: 12px; color: #666; margin-top: 4px;">
              Optional: Give this card a friendly name for easy reference
            </p>
          </div>

          <!-- Content Editor -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">
              <i data-lucide="file-text" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></i>
              Content
            </label>
            <textarea 
              id="editContentArea" 
              class="chat-input" 
              placeholder="Enter your content here..."
              style="width: 100%; min-height: 300px; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 13px; line-height: 1.6; resize: vertical;"
            ></textarea>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 8px; justify-content: flex-end;">
            <button 
              class="btn btn-secondary" 
              onclick="closeEditPanel()"
              style="font-size: 14px; padding: 10px 20px;"
            >
              <i data-lucide="x" style="width: 14px; height: 14px;"></i>
              Cancel
            </button>
            <button 
              class="btn" 
              onclick="saveEditedCard()"
              style="font-size: 14px; padding: 10px 20px;"
            >
              <i data-lucide="save" style="width: 14px; height: 14px;"></i>
              <span id="editSaveButtonText">Save</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for viewing card details -->
  <div class="modal" id="cardModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>MCard Details</h2>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content will be populated here -->
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div class="toast" id="toast">
    <span id="toastIcon">‚úì</span>
    <span id="toastMessage">Success!</span>
  </div>

  <!-- Sidebar collapse functionality -->
  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('collapsed');
      
      // Re-initialize Lucide icons after DOM change
      if (window.lucide) {
        setTimeout(() => lucide.createIcons(), 100);
      }
    }

    // Auto-collapse sidebar on mobile devices
    function initializeSidebarState() {
      const sidebar = document.getElementById('sidebar');
      if (!sidebar) {
        console.warn('[Sidebar] Element not found');
        return;
      }
      
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        // Always collapse on mobile
        if (!sidebar.classList.contains('collapsed')) {
          sidebar.classList.add('collapsed');
        }
        console.log('[Sidebar] Auto-collapsed on mobile device (width: ' + window.innerWidth + 'px)');
      } else {
        // Always expand on desktop
        if (sidebar.classList.contains('collapsed')) {
          sidebar.classList.remove('collapsed');
        }
        console.log('[Sidebar] Auto-expanded on desktop (width: ' + window.innerWidth + 'px)');
      }
    }

    // Run immediately when script loads
    initializeSidebarState();
    
    // Also run on DOMContentLoaded to be safe
    window.addEventListener('DOMContentLoaded', initializeSidebarState);
    
    // Re-check on window resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        const sidebar = document.getElementById('sidebar');
        const isMobile = window.innerWidth <= 768;
        
        // Auto-collapse when resizing to mobile
        if (isMobile && !sidebar.classList.contains('collapsed')) {
          sidebar.classList.add('collapsed');
          console.log('[Sidebar] Auto-collapsed on resize to mobile');
        }
        // Auto-expand when resizing to desktop (optional)
        // Uncomment if you want sidebar to expand on desktop
        // else if (!isMobile && sidebar.classList.contains('collapsed')) {
        //   sidebar.classList.remove('collapsed');
        //   console.log('[Sidebar] Auto-expanded on resize to desktop');
        // }
      }, 250);
    });

    // Search filter functionality
    function toggleSearchFilters() {
      const filtersPanel = document.getElementById('searchFilters');
      const toggleBtn = document.getElementById('filterToggleBtn');
      
      console.log('[Filter] Toggle clicked, current display:', filtersPanel.style.display);
      
      if (filtersPanel.style.display === 'none' || filtersPanel.style.display === '') {
        filtersPanel.style.display = 'block';
        toggleBtn.classList.add('active');
        console.log('[Filter] Showing filters panel');
      } else {
        filtersPanel.style.display = 'none';
        toggleBtn.classList.remove('active');
        console.log('[Filter] Hiding filters panel');
      }
      
      // Re-initialize Lucide icons
      if (window.lucide) {
        setTimeout(() => lucide.createIcons(), 100);
      }
    }

    function applySearchFilters() {
      // Get filter values
      const withHandles = document.getElementById('filterWithHandles').checked;
      const capital = document.getElementById('filterCapital').checked;
      const markdown = document.getElementById('filterMarkdown').checked;
      const images = document.getElementById('filterImages').checked;
      const videos = document.getElementById('filterVideos').checked;
      const sortBy = document.querySelector('input[name="sortBy"]:checked').value;
      
      // Store filters in window object for MCardManager to access
      window.searchFilters = {
        withHandles,
        capital,
        markdown,
        images,
        videos,
        sortBy
      };
      
      // Trigger search update
      if (window.mcardManager) {
        window.mcardManager.applyFiltersAndSearch();
      }
    }

    function clearSearchFilters() {
      // Uncheck all checkboxes
      document.getElementById('filterWithHandles').checked = false;
      document.getElementById('filterCapital').checked = false;
      document.getElementById('filterMarkdown').checked = false;
      document.getElementById('filterImages').checked = false;
      document.getElementById('filterVideos').checked = false;
      
      // Reset sort to newest
      document.querySelector('input[name="sortBy"][value="newest"]').checked = true;
      
      // Clear filters and refresh
      window.searchFilters = null;
      if (window.mcardManager) {
        window.mcardManager.applyFiltersAndSearch();
      }
    }

    // Close filters when clicking outside
    document.addEventListener('click', function(event) {
      const filtersPanel = document.getElementById('searchFilters');
      const toggleBtn = document.getElementById('filterToggleBtn');
      const searchBox = document.getElementById('searchBox');
      
      if (filtersPanel && toggleBtn && searchBox) {
        if (!filtersPanel.contains(event.target) && 
            !toggleBtn.contains(event.target) && 
            !searchBox.contains(event.target)) {
          filtersPanel.style.display = 'none';
          toggleBtn.classList.remove('active');
        }
      }
    });
  </script>

  <!-- Performance Monitoring -->
  <script src="/js/performance-monitor.js"></script>

  <!-- MCard Manager JavaScript (Modular Version) -->
  <script type="module" src="/js/mcard-manager-new.js"></script>

  <!-- PWA Service Worker Registration -->
  <script>
    // Register service worker for PWA functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('[PWA] Service Worker registered successfully:', registration.scope);
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              console.log('[PWA] New service worker found, installing...');
              
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('[PWA] New version available! Refresh to update.');
                  
                  // Show update notification
                  if (confirm('A new version of MCard Manager is available. Reload to update?')) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch((error) => {
            console.error('[PWA] Service Worker registration failed:', error);
          });

        // Handle service worker updates
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!refreshing) {
            refreshing = true;
            window.location.reload();
          }
        });
      });
    }

    // PWA Install prompt
    let deferredPrompt;
    let installPromptShown = false;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('[PWA] ‚úÖ Native install prompt available!');
      console.log('[PWA] Event details:', e);
      console.log('[PWA] Browser:', navigator.userAgent);
      console.log('[PWA] Display mode:', window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser');
      
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      
      // Store the event so it can be triggered later
      deferredPrompt = e;
      
      // Show modal immediately when native prompt is available (Android Chrome/Edge, Desktop Chrome/Edge)
      if (!installPromptShown && !window.matchMedia('(display-mode: standalone)').matches && !window.navigator.standalone) {
        console.log('[PWA] üöÄ Showing install modal with native prompt support');
        installPromptShown = true;
        showInstallPromotion();
      } else {
        console.log('[PWA] ‚ÑπÔ∏è  Install prompt not shown (already shown or app installed)');
      }
    });

    // Diagnostic check after 3 seconds
    setTimeout(() => {
      console.log('[PWA] üîç Diagnostic Check:');
      console.log('  - beforeinstallprompt fired:', !!deferredPrompt);
      console.log('  - Service worker registered:', !!navigator.serviceWorker.controller);
      console.log('  - Is HTTPS:', location.protocol === 'https:' || location.hostname === 'localhost');
      console.log('  - Display mode:', window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser');
      console.log('  - User agent:', navigator.userAgent);
      
      if (!deferredPrompt) {
        console.log('[PWA] ‚ö†Ô∏è  Possible reasons for no beforeinstallprompt:');
        console.log('  1. App already installed');
        console.log('  2. User dismissed prompt too many times (Chrome blocks it)');
        console.log('  3. Manifest or service worker issue');
        console.log('  4. Browser does not support PWA install');
        console.log('  5. PWA criteria not met');
      }
    }, 3000);
    
    // Fallback: Show modal after 5 seconds if beforeinstallprompt hasn't fired
    // (for browsers that don't support it or if user doesn't meet criteria)
    setTimeout(() => {
      if (!installPromptShown && !window.matchMedia('(display-mode: standalone)').matches && !window.navigator.standalone) {
        console.log('[PWA] ‚ö†Ô∏è  Native prompt not available after 5s, showing manual instructions');
        console.log('[PWA] deferredPrompt status:', !!deferredPrompt);
        installPromptShown = true;
        showInstallPromotion();
      } else if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
        console.log('[PWA] ‚úÖ Already installed, skipping modal');
      }
    }, 5000);

    function showInstallPromotion() {
      // Check if already dismissed
      const dismissed = localStorage.getItem('pwa-install-dismissed');
      if (dismissed && Date.now() - parseInt(dismissed) < 7 * 24 * 60 * 60 * 1000) {
        console.log('[PWA] Install prompt dismissed recently');
        return;
      }

      // Create modal backdrop
      const backdrop = document.createElement('div');
      backdrop.id = 'pwa-install-backdrop';
      backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
        padding: 20px;
      `;

      // Create modal
      const modal = document.createElement('div');
      modal.id = 'pwa-install-modal';
      modal.style.cssText = `
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 480px;
        width: 100%;
        animation: slideUp 0.3s ease-out;
        overflow: hidden;
      `;

      modal.innerHTML = `
        <style>
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          @keyframes slideUp {
            from { 
              opacity: 0;
              transform: translateY(30px) scale(0.95);
            }
            to { 
              opacity: 1;
              transform: translateY(0) scale(1);
            }
          }
          @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
          }
          @keyframes slideDown {
            from { 
              opacity: 1;
              transform: translateY(0) scale(1);
            }
            to { 
              opacity: 0;
              transform: translateY(30px) scale(0.95);
            }
          }
        </style>
        
        <!-- Modal Header -->
        <div style="
          background: linear-gradient(135deg, #007acc 0%, #005a9e 100%);
          padding: 32px 24px;
          text-align: center;
          color: white;
        ">
          <div style="
            width: 80px;
            height: 80px;
            margin: 0 auto 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
          ">
            <i data-lucide="download-cloud" style="width: 48px; height: 48px;"></i>
          </div>
          <h2 style="
            margin: 0 0 8px 0;
            font-size: 24px;
            font-weight: 700;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          ">Install MCard Manager</h2>
          <p style="
            margin: 0;
            font-size: 15px;
            opacity: 0.95;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          ">Get the best experience with our app</p>
        </div>

        <!-- Modal Body -->
        <div style="padding: 24px;">
          <div style="
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          ">
            <div style="display: flex; align-items: start; gap: 12px;">
              <div style="
                width: 40px;
                height: 40px;
                min-width: 40px;
                background: #e3f2fd;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
              ">
                <i data-lucide="zap" style="width: 20px; height: 20px; color: #007acc;"></i>
              </div>
              <div>
                <div style="font-weight: 600; font-size: 15px; color: #1a1a1a; margin-bottom: 4px;">
                  Lightning Fast
                </div>
                <div style="font-size: 14px; color: #666; line-height: 1.5;">
                  Instant loading and smooth performance
                </div>
              </div>
            </div>

            <div style="display: flex; align-items: start; gap: 12px;">
              <div style="
                width: 40px;
                height: 40px;
                min-width: 40px;
                background: #e8f5e9;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
              ">
                <i data-lucide="wifi-off" style="width: 20px; height: 20px; color: #4caf50;"></i>
              </div>
              <div>
                <div style="font-weight: 600; font-size: 15px; color: #1a1a1a; margin-bottom: 4px;">
                  Works Offline
                </div>
                <div style="font-size: 14px; color: #666; line-height: 1.5;">
                  Access your cards without internet
                </div>
              </div>
            </div>

            <div style="display: flex; align-items: start; gap: 12px;">
              <div style="
                width: 40px;
                height: 40px;
                min-width: 40px;
                background: #fff3e0;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
              ">
                <i data-lucide="smartphone" style="width: 20px; height: 20px; color: #ff9800;"></i>
              </div>
              <div>
                <div style="font-weight: 600; font-size: 15px; color: #1a1a1a; margin-bottom: 4px;">
                  Native Experience
                </div>
                <div style="font-size: 14px; color: #666; line-height: 1.5;">
                  Feels like a native mobile app
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px;">
            <button id="modal-install-btn" style="
              flex: 1;
              background: linear-gradient(135deg, #007acc 0%, #005a9e 100%);
              color: white;
              border: none;
              padding: 14px 24px;
              border-radius: 10px;
              font-weight: 600;
              cursor: pointer;
              font-size: 15px;
              transition: all 0.2s;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              box-shadow: 0 4px 12px rgba(0, 122, 204, 0.3);
            ">
              Install Now
            </button>
            <button id="modal-dismiss-btn" style="
              flex: 1;
              background: #f5f5f5;
              color: #666;
              border: none;
              padding: 14px 24px;
              border-radius: 10px;
              font-weight: 600;
              cursor: pointer;
              font-size: 15px;
              transition: all 0.2s;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            ">
              Maybe Later
            </button>
          </div>
        </div>
      `;

      // Add hover effects
      const style = document.createElement('style');
      style.textContent = `
        #modal-install-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 16px rgba(0, 122, 204, 0.4);
        }
        #modal-install-btn:active {
          transform: translateY(0);
        }
        #modal-dismiss-btn:hover {
          background: #e0e0e0;
        }
        @media (max-width: 480px) {
          #pwa-install-modal {
            margin: 0 16px;
          }
        }
      `;
      document.head.appendChild(style);

      backdrop.appendChild(modal);
      document.body.appendChild(backdrop);

      // Initialize Lucide icons
      if (window.lucide) {
        lucide.createIcons();
      }

      // Close modal function
      function closeModal() {
        backdrop.style.animation = 'fadeOut 0.2s ease-out';
        modal.style.animation = 'slideDown 0.2s ease-out';
        setTimeout(() => backdrop.remove(), 200);
      }

      // Install button handler
      document.getElementById('modal-install-btn').addEventListener('click', async () => {
        console.log('[PWA] üéØ Install button clicked!');
        console.log('[PWA] deferredPrompt available:', !!deferredPrompt);
        console.log('[PWA] deferredPrompt object:', deferredPrompt);
        console.log('[PWA] User agent:', navigator.userAgent);
        console.log('[PWA] Is standalone:', window.matchMedia('(display-mode: standalone)').matches);
        console.log('[PWA] Navigator standalone:', window.navigator.standalone);
        
        // Force check if we're on desktop Chrome and should have native prompt
        const isDesktopChrome = /Chrome/i.test(navigator.userAgent) && 
                               !/Mobile|Android/i.test(navigator.userAgent) &&
                               !/Edge/i.test(navigator.userAgent);
        console.log('[PWA] Is desktop Chrome:', isDesktopChrome);
        
        if (deferredPrompt) {
          // Native install prompt available (Chrome/Edge/Android)
          console.log('[PWA] üöÄ Triggering native install prompt!');
          
          try {
            // Show the native install prompt
            const promptResult = await deferredPrompt.prompt();
            console.log('[PWA] Prompt result:', promptResult);
            
            // Wait for the user's response
            const { outcome } = await deferredPrompt.userChoice;
            console.log('[PWA] User choice:', outcome);
            
            if (outcome === 'accepted') {
              console.log('[PWA] ‚úÖ App installed successfully!');
              // Show success message
              closeModal();
              setTimeout(() => {
                const successMsg = document.createElement('div');
                successMsg.style.cssText = `
                  position: fixed;
                  top: 50%;
                  left: 50%;
                  transform: translate(-50%, -50%);
                  background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
                  color: white;
                  padding: 24px 32px;
                  border-radius: 12px;
                  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                  z-index: 10001;
                  font-size: 16px;
                  font-weight: 600;
                  text-align: center;
                  animation: fadeIn 0.3s ease-out;
                `;
                successMsg.innerHTML = `
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <i data-lucide="check-circle" style="width: 24px; height: 24px;"></i>
                    <div>
                      <div style="font-size: 18px; margin-bottom: 4px;">‚úÖ Installation Successful!</div>
                      <div style="font-size: 14px; opacity: 0.9;">MCard Manager is now on your home screen</div>
                    </div>
                  </div>
                `;
                document.body.appendChild(successMsg);
                if (window.lucide) lucide.createIcons();
                setTimeout(() => successMsg.remove(), 4000);
              }, 300);
            } else {
              console.log('[PWA] ‚ùå User cancelled installation');
              closeModal();
            }
            
            // Clear the deferred prompt
            deferredPrompt = null;
          } catch (error) {
            console.error('[PWA] ‚ùå Install prompt error:', error);
            console.error('[PWA] Error details:', error.message, error.stack);
            
            // Check if it's because app is already installed
            if (error.message && error.message.includes('The app is already installed')) {
              closeModal();
              alert('‚úÖ MCard Manager is already installed on your device!');
            } else {
              // If native prompt fails, show manual instructions
              showManualInstructions();
            }
          }
        } else {
          // No native prompt available - show manual instructions
          console.log('[PWA] ‚ö†Ô∏è  Native prompt not available, showing manual instructions');
          console.log('[PWA] Possible reasons:');
          console.log('  - App already installed');
          console.log('  - Browser does not support PWA install');
          console.log('  - User has dismissed prompt too many times');
          console.log('  - Not served over HTTPS (localhost is OK)');
          console.log('  - Service worker not registered');
          
          // Check if already installed
          if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
            closeModal();
            alert('‚úÖ MCard Manager is already installed on your device!');
          } else {
            showManualInstructions();
          }
        }
      });
      
      // Helper function for manual installation instructions
      function showManualInstructions() {
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isChrome = /Chrome/i.test(navigator.userAgent) && !/Edge/i.test(navigator.userAgent);
        const isSafari = /Safari/i.test(navigator.userAgent) && !/Chrome/i.test(navigator.userAgent);
        
        let instructions = '';
        
        if (isIOS) {
          instructions = `
üì± Install on iOS:

1. Tap the Share button (‚¨ÜÔ∏è square with arrow)
2. Scroll down and tap "Add to Home Screen"
3. Tap "Add" in the top right
4. The app icon will appear on your home screen!

‚ú® You can then open it like any other app.
          `.trim();
        } else if (isAndroid) {
          instructions = `
üì± Install on Android:

1. Tap the menu (‚ãÆ) in the top right corner
2. Look for "Add to Home screen" or "Install app"
3. Tap it and confirm
4. The app icon will appear on your home screen!

‚ú® You can then open it like any other app.

Note: Make sure you're using Chrome or Edge browser.
          `.trim();
        } else if (isChrome) {
          instructions = `
üíª Install on Desktop (Chrome):

1. Click the install icon (‚äï) in the address bar
   OR
2. Click menu (‚ãÆ) ‚Üí "Install MCard Manager"
3. Click "Install" in the popup
4. The app will open in its own window!

‚ú® You can then find it in your applications.
          `.trim();
        } else if (isSafari) {
          instructions = `
üíª Install on Safari:

Safari doesn't support PWA installation on desktop.

Please use Chrome, Edge, or Firefox for the best experience.

Or visit on your iPhone/iPad to install as an app!
          `.trim();
        } else {
          instructions = `
üíª Install on Desktop:

1. Look for an install icon in your browser's address bar
2. Or check your browser's menu for "Install" option
3. Click it to install the app

Supported browsers:
‚úÖ Chrome
‚úÖ Edge
‚úÖ Firefox
‚úÖ Opera

‚ú® The app will open in its own window!
          `.trim();
        }
        
        alert(instructions);
        closeModal();
      }

      // Dismiss button handler
      document.getElementById('modal-dismiss-btn').addEventListener('click', () => {
        localStorage.setItem('pwa-install-dismissed', Date.now());
        console.log('[PWA] Install prompt dismissed for 7 days');
        closeModal();
      });

      // Close on backdrop click
      backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) {
          closeModal();
        }
      });

      // Close on ESC key
      const escHandler = (e) => {
        if (e.key === 'Escape') {
          closeModal();
          document.removeEventListener('keydown', escHandler);
        }
      };
      document.addEventListener('keydown', escHandler);
    }

    // Online/Offline Detection
    function updateOnlineStatus() {
      const indicator = document.getElementById('offline-indicator');
      if (!navigator.onLine) {
        console.log('[PWA] üîå OFFLINE MODE - Working from cache');
        indicator.style.display = 'block';
        if (window.lucide) lucide.createIcons();
      } else {
        console.log('[PWA] üåê ONLINE MODE');
        indicator.style.display = 'none';
      }
    }

    window.addEventListener('online', () => {
      console.log('[PWA] ‚úÖ Connection restored!');
      updateOnlineStatus();
      // Show brief notification
      const indicator = document.getElementById('offline-indicator');
      indicator.style.background = 'linear-gradient(135deg, #51cf66 0%, #37b24d 100%)';
      indicator.innerHTML = '<i data-lucide="wifi" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;"></i>Back online!';
      indicator.style.display = 'block';
      if (window.lucide) lucide.createIcons();
      setTimeout(() => {
        indicator.style.display = 'none';
        indicator.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)';
        indicator.innerHTML = '<i data-lucide="wifi-off" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;"></i>You\'re offline - Working from cache';
      }, 3000);
    });

    window.addEventListener('offline', () => {
      console.log('[PWA] ‚ö†Ô∏è  Connection lost - Switching to offline mode');
      updateOnlineStatus();
    });

    // Check initial status
    window.addEventListener('load', () => {
      updateOnlineStatus();
      
      // Detect if app is running as PWA
      if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
        console.log('[PWA] Running as installed app');
        document.body.classList.add('pwa-mode');
      }
    });

    // Handle share target (if app receives shared content)
    if (window.location.search.includes('share-target')) {
      console.log('[PWA] Received shared content');
      // Handle shared content here
    }

    // Calendar View Functions
    function showCalendar() {
      console.log('[Calendar] Opening calendar view');
      const calendarView = document.getElementById('calendarView');
      const mainContent = document.querySelector('.main-content');
      
      // Hide main content
      if (mainContent) {
        mainContent.style.display = 'none';
      }
      
      // Show calendar view
      calendarView.style.display = 'flex';
      
      // Re-initialize Lucide icons
      if (window.lucide) {
        lucide.createIcons();
      }
      
      console.log('[Calendar] Calendar view opened');
    }

    function hideCalendar() {
      console.log('[Calendar] Closing calendar view');
      const calendarView = document.getElementById('calendarView');
      const mainContent = document.querySelector('.main-content');
      
      // Hide calendar view
      calendarView.style.display = 'none';
      
      // Show main content
      if (mainContent) {
        mainContent.style.display = 'flex';
      }
      
      console.log('[Calendar] Calendar view closed');
    }

    // ESC key to close calendar
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const calendarView = document.getElementById('calendarView');
        if (calendarView && calendarView.style.display === 'flex') {
          hideCalendar();
        }
      }
    });
  </script>
</body>
</html>
